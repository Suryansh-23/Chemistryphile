{"ast":null,"code":"/*\n  ServerJS Javascript DOM Level 1\n*/\nvar inheritFrom = require(\"../utils\").inheritFrom;\n\nvar domToHtml = require(\"../browser/domtohtml\").domToHtml;\n\nvar defineGetter = require(\"../utils\").defineGetter;\n\nvar memoizeQuery = require(\"../utils\").memoizeQuery;\n\nvar validateName = require('../living/helpers/validate-names').name;\n\nvar Location = require(\"../browser/location\"); // utility functions\n\n\nvar attachId = function (id, elm, doc) {\n  if (id && elm && doc) {\n    if (!doc._ids[id]) {\n      doc._ids[id] = [];\n    }\n\n    doc._ids[id].push(elm);\n  }\n};\n\nvar detachId = function (id, elm, doc) {\n  var elms, i;\n\n  if (id && elm && doc) {\n    if (doc._ids && doc._ids[id]) {\n      elms = doc._ids[id];\n\n      for (i = 0; i < elms.length; i++) {\n        if (elms[i] === elm) {\n          elms.splice(i, 1);\n          i--;\n        }\n      }\n\n      if (elms.length === 0) {\n        delete doc._ids[id];\n      }\n    }\n  }\n};\n\nfunction setInnerHTML(dom, node, html) {\n  //Clear the children first:\n  var child;\n\n  while (child = node._childNodes[0]) {\n    node.removeChild(child);\n  }\n\n  var isDoc = node.nodeName === '#document';\n\n  if (html !== \"\" && html != null) {\n    if (isDoc) {\n      dom._htmlToDom.appendHtmlToDocument(html, node);\n    } else {\n      dom._htmlToDom.appendHtmlToElement(html, node);\n    }\n  }\n} // TODO: move all of these to utils.js. Right now they are exposed on window, which is bizarre.\n\n\nvar core = module.exports = {\n  mapper: function (parent, filter, recursive) {\n    return function () {\n      return core.mapDOMNodes(parent, recursive !== false, filter);\n    };\n  },\n  // Returns Array\n  mapDOMNodes: function (parent, recursive, callback) {\n    function visit(parent, result) {\n      return parent._childNodes.reduce(reducer, result);\n    }\n\n    function reducer(array, child) {\n      if (callback(child)) {\n        array.push(child);\n      }\n\n      if (recursive && child._childNodes) {\n        visit(child, array);\n      }\n\n      return array;\n    }\n\n    return visit(parent, []);\n  },\n  visitTree: function (root, callback) {\n    var cur = root; // TODO: Unroll this.\n\n    function visit(el) {\n      if (el) {\n        callback(el);\n\n        if (el._childNodes) {\n          var i = 0,\n              children = el._childNodes,\n              l = children.length;\n\n          for (i; i < l; i++) {\n            visit(children[i]);\n          }\n        }\n      }\n    }\n\n    visit(root);\n  },\n  markTreeReadonly: function (node) {\n    function markLevel(el) {\n      el._readonly = true; // also mark attributes and their children read-only\n\n      if (el.attributes) {\n        var attributes = el.attributes,\n            l = attributes.length,\n            i = 0;\n        attributes._readonly = true;\n\n        for (i; i < l; i++) {\n          core.visitTree(attributes[i], markLevel);\n        }\n      }\n    }\n\n    core.visitTree(node, markLevel);\n  }\n}; // ExceptionCode\n\nvar INDEX_SIZE_ERR = core.INDEX_SIZE_ERR = 1,\n    DOMSTRING_SIZE_ERR = core.DOMSTRING_SIZE_ERR = 2,\n    HIERARCHY_REQUEST_ERR = core.HIERARCHY_REQUEST_ERR = 3,\n    WRONG_DOCUMENT_ERR = core.WRONG_DOCUMENT_ERR = 4,\n    INVALID_CHARACTER_ERR = core.INVALID_CHARACTER_ERR = 5,\n    NO_DATA_ALLOWED_ERR = core.NO_DATA_ALLOWED_ERR = 6,\n    NO_MODIFICATION_ALLOWED_ERR = core.NO_MODIFICATION_ALLOWED_ERR = 7,\n    NOT_FOUND_ERR = core.NOT_FOUND_ERR = 8,\n    NOT_SUPPORTED_ERR = core.NOT_SUPPORTED_ERR = 9,\n    INUSE_ATTRIBUTE_ERR = core.INUSE_ATTRIBUTE_ERR = 10,\n    INVALID_STATE_ERR = core.INVALID_STATE_ERR = 11,\n    SYNTAX_ERR = core.SYNTAX_ERR = 12,\n    INVALID_MODIFICATION_ERR = core.INVALID_MODIFICATION_ERR = 13,\n    NAMESPACE_ERR = core.NAMESPACE_ERR = 14,\n    INVALID_ACCESS_ERR = core.INVALID_ACCESS_ERR = 15,\n    // Node Types\nELEMENT_NODE = 1,\n    ATTRIBUTE_NODE = 2,\n    TEXT_NODE = 3,\n    CDATA_SECTION_NODE = 4,\n    ENTITY_REFERENCE_NODE = 5,\n    ENTITY_NODE = 6,\n    PROCESSING_INSTRUCTION_NODE = 7,\n    COMMENT_NODE = 8,\n    DOCUMENT_NODE = 9,\n    DOCUMENT_TYPE_NODE = 10,\n    DOCUMENT_FRAGMENT_NODE = 11,\n    NOTATION_NODE = 12;\nvar messages = core.exceptionMessages = {};\nmessages[INDEX_SIZE_ERR] = \"Index size error\";\nmessages[DOMSTRING_SIZE_ERR] = \"DOMString size error\";\nmessages[HIERARCHY_REQUEST_ERR] = \"Hierarchy request error\";\nmessages[WRONG_DOCUMENT_ERR] = \"Wrong document\";\nmessages[INVALID_CHARACTER_ERR] = \"Invalid character\";\nmessages[NO_DATA_ALLOWED_ERR] = \"No data allowed\";\nmessages[NO_MODIFICATION_ALLOWED_ERR] = \"No modification allowed\";\nmessages[NOT_FOUND_ERR] = \"Not found\";\nmessages[NOT_SUPPORTED_ERR] = \"Not supported\";\nmessages[INUSE_ATTRIBUTE_ERR] = \"Attribute in use\";\nmessages[NAMESPACE_ERR] = \"Invalid namespace\";\n\ncore.DOMException = function DOMException(code, message) {\n  Error.call(this, core.exceptionMessages[code]);\n  this.message = core.exceptionMessages[code];\n  this.code = code;\n\n  if (message) {\n    this.message = this.message + \": \" + message;\n  }\n\n  if (Error.captureStackTrace) {\n    Error.captureStackTrace(this, DOMException);\n  }\n};\n\ncore.DOMException.INDEX_SIZE_ERR = INDEX_SIZE_ERR;\ncore.DOMException.DOMSTRING_SIZE_ERR = DOMSTRING_SIZE_ERR;\ncore.DOMException.HIERARCHY_REQUEST_ERR = HIERARCHY_REQUEST_ERR;\ncore.DOMException.WRONG_DOCUMENT_ERR = WRONG_DOCUMENT_ERR;\ncore.DOMException.INVALID_CHARACTER_ERR = INVALID_CHARACTER_ERR;\ncore.DOMException.NO_DATA_ALLOWED_ERR = NO_DATA_ALLOWED_ERR;\ncore.DOMException.NO_MODIFICATION_ALLOWED_ERR = NO_MODIFICATION_ALLOWED_ERR;\ncore.DOMException.NOT_FOUND_ERR = NOT_FOUND_ERR;\ncore.DOMException.NOT_SUPPORTED_ERR = NOT_SUPPORTED_ERR;\ncore.DOMException.INUSE_ATTRIBUTE_ERR = INUSE_ATTRIBUTE_ERR;\ncore.DOMException.INVALID_STATE_ERR = INVALID_STATE_ERR;\ncore.DOMException.SYNTAX_ERR = SYNTAX_ERR;\ncore.DOMException.INVALID_MODIFICATION_ERR = INVALID_MODIFICATION_ERR;\ncore.DOMException.NAMESPACE_ERR = NAMESPACE_ERR;\ncore.DOMException.INVALID_ACCESS_ERR = INVALID_ACCESS_ERR;\ninheritFrom(Error, core.DOMException, {\n  name: \"DOMException\",\n  INDEX_SIZE_ERR: INDEX_SIZE_ERR,\n  DOMSTRING_SIZE_ERR: DOMSTRING_SIZE_ERR,\n  HIERARCHY_REQUEST_ERR: HIERARCHY_REQUEST_ERR,\n  WRONG_DOCUMENT_ERR: WRONG_DOCUMENT_ERR,\n  INVALID_CHARACTER_ERR: INVALID_CHARACTER_ERR,\n  NO_DATA_ALLOWED_ERR: NO_DATA_ALLOWED_ERR,\n  NO_MODIFICATION_ALLOWED_ERR: NO_MODIFICATION_ALLOWED_ERR,\n  NOT_FOUND_ERR: NOT_FOUND_ERR,\n  NOT_SUPPORTED_ERR: NOT_SUPPORTED_ERR,\n  INUSE_ATTRIBUTE_ERR: INUSE_ATTRIBUTE_ERR,\n  INVALID_STATE_ERR: INVALID_STATE_ERR,\n  SYNTAX_ERR: SYNTAX_ERR,\n  INVALID_MODIFICATION_ERR: INVALID_MODIFICATION_ERR,\n  NAMESPACE_ERR: NAMESPACE_ERR,\n  INVALID_ACCESS_ERR: INVALID_ACCESS_ERR\n});\n\ncore.NodeList = function NodeList(element, query) {\n  if (!query) {\n    // Non-live NodeList\n    if (Array.isArray(element)) {\n      Array.prototype.push.apply(this, element);\n    }\n\n    Object.defineProperties(this, {\n      _length: {\n        value: element ? element.length : 0,\n        writable: true\n      }\n    });\n  } else {\n    Object.defineProperties(this, {\n      _element: {\n        value: element\n      },\n      _query: {\n        value: query\n      },\n      _snapshot: {\n        writable: true\n      },\n      _length: {\n        value: 0,\n        writable: true\n      },\n      _version: {\n        value: -1,\n        writable: true\n      }\n    });\n\n    this._update();\n  }\n};\n\nfunction lengthFromProperties(arrayLike) {\n  var max = -1;\n  var keys = Object.keys(arrayLike);\n  var highestKeyIndex = keys.length - 1; // abuses a v8 implementation detail for a very fast case\n  // (if this implementation detail changes, this method will still\n  //  return correct results)\n\n  if (highestKeyIndex == keys[highestKeyIndex]) {\n    // not ===\n    return keys.length;\n  }\n\n  for (var i = highestKeyIndex; i >= 0; --i) {\n    var asNumber = +keys[i];\n\n    if (!isNaN(asNumber) && asNumber > max) {\n      max = asNumber;\n    }\n  }\n\n  return max + 1;\n}\n\ncore.NodeList.prototype = {\n  _update: function () {\n    var i;\n\n    if (!this._element) {\n      this._length = lengthFromProperties(this);\n    } else {\n      if (this._version < this._element._version) {\n        var nodes = this._snapshot = this._query();\n\n        this._resetTo(nodes);\n\n        this._version = this._element._version;\n      }\n    }\n  },\n  _resetTo: function (array) {\n    var startingLength = lengthFromProperties(this);\n\n    for (var i = 0; i < startingLength; ++i) {\n      delete this[i];\n    }\n\n    for (var j = 0; j < array.length; ++j) {\n      this[j] = array[j];\n    }\n\n    this._length = array.length;\n  },\n  _toArray: function () {\n    if (this._element) {\n      this._update();\n\n      return this._snapshot;\n    }\n\n    return Array.prototype.slice.call(this);\n  },\n\n  get length() {\n    this._update();\n\n    return this._length || 0;\n  },\n\n  set length(length) {\n    return this._length;\n  },\n\n  item: function (index) {\n    this._update();\n\n    return this[index] || null;\n  },\n  toString: function () {\n    return '[ jsdom NodeList ]: contains ' + this.length + ' items';\n  }\n};\nObject.defineProperty(core.NodeList.prototype, 'constructor', {\n  value: core.NodeList,\n  writable: true,\n  configurable: true\n});\n\ncore.DOMImplementation = function DOMImplementation(document,\n/* Object */\nfeatures) {\n  this._ownerDocument = document;\n  this._features = {};\n\n  if (features) {\n    for (var feature in features) {\n      if (features.hasOwnProperty(feature)) {\n        this._addFeature(feature.toLowerCase(), features[feature]);\n      }\n    }\n  }\n};\n\ncore.DOMImplementation.prototype = {\n  // All of these are legacy, left because jsdom uses them internally :(. jsdom confused the idea of browser features\n  // and jsdom features\n  _removeFeature: function (feature, version) {\n    feature = feature.toLowerCase();\n\n    if (this._features[feature]) {\n      if (version) {\n        var j = 0,\n            versions = this._features[feature],\n            l = versions.length;\n\n        for (j; j < l; j++) {\n          if (versions[j] === version) {\n            versions.splice(j, 1);\n            return;\n          }\n        }\n      } else {\n        delete this._features[feature];\n      }\n    }\n  },\n  _addFeature: function (feature, version) {\n    feature = feature.toLowerCase();\n\n    if (version) {\n      if (!this._features[feature]) {\n        this._features[feature] = [];\n      }\n\n      if (version instanceof Array) {\n        Array.prototype.push.apply(this._features[feature], version);\n      } else {\n        this._features[feature].push(version);\n      }\n    }\n  },\n  // The real hasFeature is in living/dom-implementation.js, and returns true always.\n  // This one is used internally\n  _hasFeature: function (\n  /* string */\n  feature,\n  /* string */\n  version) {\n    feature = feature ? feature.toLowerCase() : '';\n    var versions = this._features[feature] ? this._features[feature] : false;\n\n    if (!version && versions.length && versions.length > 0) {\n      return true;\n    } else if (typeof versions === 'string') {\n      return versions === version;\n    } else if (versions.indexOf && versions.length > 0) {\n      for (var i = 0; i < versions.length; i++) {\n        var found = versions[i] instanceof RegExp ? versions[i].test(version) : versions[i] === version;\n\n        if (found) {\n          return true;\n        }\n      }\n\n      return false;\n    } else {\n      return false;\n    }\n  }\n};\n\nvar attrCopy = function (src, dest, fn) {\n  if (src.attributes) {\n    var attrs = src.attributes,\n        i,\n        l = attrs.length,\n        attr,\n        copied;\n\n    for (i = 0; i < l; i++) {\n      attr = attrs[i]; // skip over default attributes\n\n      if (!attr.specified) {\n        continue;\n      } // TODO: consider duplicating this code and moving it into level2/core\n\n\n      if (attr.namespaceURI) {\n        dest.setAttributeNS(attr.namespaceURI, attr.name, attr.value);\n        var localName = attr.name.split(':').pop();\n        copied = dest.getAttributeNodeNS(attr.namespaceURI, localName);\n      } else {\n        dest.setAttribute(attr.name, attr.value);\n        copied = dest.getAttributeNode(attr.name);\n      }\n\n      if (typeof fn == \"function\") {\n        fn(attr, copied);\n      }\n    }\n  }\n\n  return dest;\n};\n\ncore.Node = function Node(ownerDocument) {\n  this._childNodes = [];\n  this._childNodesList = null;\n  this._ownerDocument = ownerDocument;\n  this._attributes = new AttributeList(ownerDocument, this);\n  this._childrenList = null;\n  this._version = 0;\n  this._parentNode = null;\n  this._memoizedQueries = {};\n  this._readonly = false;\n};\n\ncore.Node.ELEMENT_NODE = ELEMENT_NODE;\ncore.Node.ATTRIBUTE_NODE = ATTRIBUTE_NODE;\ncore.Node.TEXT_NODE = TEXT_NODE;\ncore.Node.CDATA_SECTION_NODE = CDATA_SECTION_NODE;\ncore.Node.ENTITY_REFERENCE_NODE = ENTITY_REFERENCE_NODE;\ncore.Node.ENTITY_NODE = ENTITY_NODE;\ncore.Node.PROCESSING_INSTRUCTION_NODE = PROCESSING_INSTRUCTION_NODE;\ncore.Node.COMMENT_NODE = COMMENT_NODE;\ncore.Node.DOCUMENT_NODE = DOCUMENT_NODE;\ncore.Node.DOCUMENT_TYPE_NODE = DOCUMENT_TYPE_NODE;\ncore.Node.DOCUMENT_FRAGMENT_NODE = DOCUMENT_FRAGMENT_NODE;\ncore.Node.NOTATION_NODE = NOTATION_NODE;\ncore.Node.prototype = {\n  ELEMENT_NODE: ELEMENT_NODE,\n  ATTRIBUTE_NODE: ATTRIBUTE_NODE,\n  TEXT_NODE: TEXT_NODE,\n  CDATA_SECTION_NODE: CDATA_SECTION_NODE,\n  ENTITY_REFERENCE_NODE: ENTITY_REFERENCE_NODE,\n  ENTITY_NODE: ENTITY_NODE,\n  PROCESSING_INSTRUCTION_NODE: PROCESSING_INSTRUCTION_NODE,\n  COMMENT_NODE: COMMENT_NODE,\n  DOCUMENT_NODE: DOCUMENT_NODE,\n  DOCUMENT_TYPE_NODE: DOCUMENT_TYPE_NODE,\n  DOCUMENT_FRAGMENT_NODE: DOCUMENT_FRAGMENT_NODE,\n  NOTATION_NODE: NOTATION_NODE,\n\n  get children() {\n    if (!this._childrenList) {\n      var self = this;\n      this._childrenList = new core.NodeList(this, function () {\n        return self._childNodes.filter(function (node) {\n          return node.tagName;\n        });\n      });\n    }\n\n    this._childrenList._update();\n\n    return this._childrenList;\n  },\n\n  get nodeValue() {\n    if (this.nodeType === core.Node.TEXT_NODE || this.nodeType === core.Node.COMMENT_NODE || this.nodeType === core.Node.PROCESSING_INSTRUCTION_NODE) {\n      return this._data;\n    }\n\n    return null;\n  },\n\n  set nodeValue(value) {\n    if (this.nodeType === core.Node.TEXT_NODE || this.nodeType === core.Node.COMMENT_NODE || this.nodeType === core.Node.PROCESSING_INSTRUCTION_NODE) {\n      this.replaceData(0, this.length, value);\n    }\n  },\n\n  get parentNode() {\n    return this._parentNode;\n  },\n\n  get nodeName() {\n    switch (this.nodeType) {\n      case ELEMENT_NODE:\n        return this.tagName;\n\n      case TEXT_NODE:\n        return \"#text\";\n\n      case PROCESSING_INSTRUCTION_NODE:\n        return this.target;\n\n      case COMMENT_NODE:\n        return \"#comment\";\n\n      case DOCUMENT_NODE:\n        return \"#document\";\n\n      case DOCUMENT_TYPE_NODE:\n        return this.name;\n\n      case DOCUMENT_FRAGMENT_NODE:\n        return \"#document-fragment\";\n\n      case ATTRIBUTE_NODE:\n        // TODO: remove this; attributes should not be nodes and should not have a nodeName property\n        // Removing it breaks some legit-seeming xpath tests :-/\n        return this.name;\n    }\n  },\n\n  set nodeName(unused) {\n    throw new core.DOMException();\n  },\n\n  get firstChild() {\n    return this._childNodes.length > 0 ? this._childNodes[0] : null;\n  },\n\n  get ownerDocument() {\n    return this._ownerDocument;\n  },\n\n  get readonly() {\n    return this._readonly;\n  },\n\n  get lastChild() {\n    var len = this._childNodes.length;\n    return len > 0 ? this._childNodes[len - 1] : null;\n  },\n\n  get childNodes() {\n    if (!this._childNodesList) {\n      var self = this;\n      this._childNodesList = new core.NodeList(this, function () {\n        return self._childNodes.slice();\n      });\n    }\n\n    this._childNodesList._update();\n\n    return this._childNodesList;\n  },\n\n  set childNodes(unused) {\n    throw new core.DOMException();\n  },\n\n  _indexOf: function (\n  /*Node*/\n  child) {\n    return this._childNodes.indexOf(child);\n  },\n\n  get nextSibling() {\n    // find this node's index in the parentNode, add one and call it a day\n    if (!this._parentNode || !this._parentNode._indexOf) {\n      return null;\n    }\n\n    var index = this._parentNode._indexOf(this);\n\n    if (index == -1 || index + 1 >= this._parentNode._childNodes.length) {\n      return null;\n    }\n\n    return this._parentNode._childNodes[index + 1] || null;\n  },\n\n  set nextSibling(unused) {\n    throw new core.DOMException();\n  },\n\n  get previousSibling() {\n    if (!this._parentNode || !this._parentNode._indexOf) {\n      return null;\n    }\n\n    var index = this._parentNode._indexOf(this);\n\n    if (index == -1 || index - 1 < 0) {\n      return null;\n    }\n\n    return this._parentNode._childNodes[index - 1] || null;\n  },\n\n  set previousSibling(unused) {\n    throw new core.DOMException();\n  },\n\n  /* returns Node */\n  insertBefore: function (\n  /* Node */\n  newChild,\n  /* Node*/\n  refChild) {\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR, 'Attempting to modify a read-only node');\n    } // Adopt unowned children, for weird nodes like DocumentType\n\n\n    if (!newChild._ownerDocument) newChild._ownerDocument = this._ownerDocument; // TODO - if (!newChild) then?\n\n    if (!(this instanceof core.Document) && newChild._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    }\n\n    if (newChild.nodeType && newChild.nodeType === ATTRIBUTE_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    } // search for parents matching the newChild\n\n\n    var current = this;\n\n    do {\n      if (current === newChild) {\n        throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n      }\n    } while (current = current._parentNode); // fragments are merged into the element (except parser-created fragments in <template>)\n\n\n    if (newChild.nodeType === DOCUMENT_FRAGMENT_NODE && !newChild._templateContent) {\n      var tmpNode,\n          i = newChild._childNodes.length;\n\n      while (i-- > 0) {\n        tmpNode = newChild.removeChild(newChild.firstChild);\n        this.insertBefore(tmpNode, refChild);\n      }\n    } else if (newChild === refChild) {\n      return newChild;\n    } else {\n      // if the newChild is already in the tree elsewhere, remove it first\n      if (newChild._parentNode) {\n        newChild._parentNode.removeChild(newChild);\n      }\n\n      if (refChild == null) {\n        this._childNodes.push(newChild);\n      } else {\n        var refChildIndex = this._indexOf(refChild);\n\n        if (refChildIndex == -1) {\n          throw new core.DOMException(NOT_FOUND_ERR);\n        }\n\n        this._childNodes.splice(refChildIndex, 0, newChild);\n      }\n\n      newChild._parentNode = this;\n\n      if (this._attached && newChild._attach) {\n        newChild._attach();\n      }\n\n      this._modified();\n\n      this._descendantAdded(this, newChild);\n    }\n\n    return newChild;\n  },\n  // raises(DOMException);\n  _modified: function () {\n    this._version++;\n\n    if (this._ownerDocument) {\n      this._ownerDocument._version++;\n    }\n\n    if (this._childrenList) {\n      this._childrenList._update();\n    }\n\n    this._clearMemoizedQueries();\n  },\n  _clearMemoizedQueries: function () {\n    this._memoizedQueries = {};\n\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._clearMemoizedQueries();\n    }\n  },\n  _descendantRemoved: function (parent, child) {\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._descendantRemoved(parent, child);\n    }\n  },\n  _descendantAdded: function (parent, child) {\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._descendantAdded(parent, child);\n    }\n  },\n  _attrModified: function (name, value, oldValue) {\n    if (name == 'id' && this._attached) {\n      var doc = this._ownerDocument;\n      detachId(oldValue, this, doc);\n      attachId(value, this, doc);\n    } // Check for inline event handlers.\n    // We can't set these like other attributes then look it up in\n    // dispatchEvent() because that would create 2 'traditional' event handlers\n    // in the case where there's an inline event handler attribute, plus one\n    // set using element.on* in a script.\n    //\n    // @see http://www.w3.org/TR/2011/WD-html5-20110405/webappapis.html#event-handler-content-attributes\n\n\n    if (name.length > 2 && name[0] == 'o' && name[1] == 'n') {\n      if (value) {\n        var self = this; // Check whether we're the window. This can happen because inline\n        // handlers on the body are proxied to the window.\n\n        var w = typeof self.run !== 'undefined' ? self : self._ownerDocument.parentWindow;\n\n        self[name] = function (event) {\n          // The handler code probably refers to functions declared in the\n          // window context, so we need to call run().\n          // Use awesome hacks to get the correct `this` context for the\n          // inline event handler. This would only be necessary if we're an\n          // element, but for the sake of simplicity we also do it on window.\n          // Also set event variable and support `return false`.\n          w.__tempContextForInlineEventHandler = self;\n          w.__tempEvent = event;\n          w.run(\"if ((function (event) {\" + value + \"}).call(\" + \"window.__tempContextForInlineEventHandler, window.__tempEvent) === false) {\" + \"window.__tempEvent.preventDefault()}\");\n          delete w.__tempContextForInlineEventHandler;\n          delete w.__tempEvent;\n        };\n      } else {\n        this[name] = null;\n      }\n    }\n  },\n\n  /* returns Node */\n  replaceChild: function (\n  /* Node */\n  newChild,\n  /* Node */\n  oldChild) {\n    this.insertBefore(newChild, oldChild);\n    return this.removeChild(oldChild);\n  },\n  //raises(DOMException);\n\n  /* returns void */\n  _attach: function () {\n    this._attached = true;\n\n    if (this.id) {\n      attachId(this.id, this, this._ownerDocument);\n    }\n\n    for (var i = 0, len = this._childNodes.length; i < len; i++) {\n      if (this._childNodes[i]._attach) {\n        this._childNodes[i]._attach();\n      }\n    }\n  },\n\n  /* returns void */\n  _detach: function () {\n    var i, elms;\n    this._attached = false;\n\n    if (this.id) {\n      detachId(this.id, this, this._ownerDocument);\n    }\n\n    for (var i = 0, len = this._childNodes.length; i < len; i++) {\n      this._childNodes[i]._detach();\n    }\n  },\n\n  /* returns Node */\n  removeChild: function (\n  /* Node */\n  oldChild) {\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    } // TODO - if (!oldChild) then?\n    // Use lastIndexOf so that removing all the children by\n    // going backwards through childNodes is fast\n    // (because of splice)\n\n\n    var oldChildIndex = this._childNodes.lastIndexOf(oldChild);\n\n    if (oldChildIndex == -1) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    this._childNodes.splice(oldChildIndex, 1);\n\n    oldChild._parentNode = null;\n\n    this._modified();\n\n    oldChild._detach();\n\n    this._descendantRemoved(this, oldChild);\n\n    return oldChild;\n  },\n  // raises(DOMException);\n\n  /* returns Node */\n  appendChild: function (\n  /* Node */\n  newChild) {\n    return this.insertBefore(newChild, null);\n  },\n  // raises(DOMException);\n\n  /* returns boolean */\n  hasChildNodes: function () {\n    return this._childNodes.length > 0;\n  },\n\n  /* returns Node */\n  cloneNode: function (\n  /* bool */\n  deep, fn) {\n    var object = null;\n\n    switch (this.nodeType) {\n      case this.ELEMENT_NODE:\n        object = attrCopy(this, this._ownerDocument.createElementNS(this.namespaceURI, this.nodeName), fn); // Using this.nodeName isn't always exact because of uppercasing-related stuff\n\n        object._prefix = this._prefix;\n        object._localName = this._localName;\n        break;\n\n      case this.TEXT_NODE:\n        object = attrCopy(this, this._ownerDocument.createTextNode(this.tagName));\n        object.nodeValue = this.nodeValue;\n        break;\n\n      case this.ATTRIBUTE_NODE:\n        object = this._ownerDocument.createAttribute(this.name);\n        break;\n        break;\n\n      case this.PROCESSING_INSTRUCTION_NODE:\n        var pi = this._ownerDocument.createProcessingInstruction(this._target, this._data);\n\n        object = attrCopy(this, pi);\n        break;\n\n      case this.COMMENT_NODE:\n        object = this._ownerDocument.createComment(this.tagName);\n        object.nodeValue = this.nodeValue;\n        break;\n\n      case this.DOCUMENT_NODE:\n        object = attrCopy(this, new this.constructor({\n          parsingMode: this._parsingMode\n        })); // TODO: clone the doctype?\n\n        break;\n\n      case this.DOCUMENT_TYPE_NODE:\n        object = new core.DocumentType(this._ownerDocument, this._name, this._publicId, this._systemId);\n        break;\n\n      case this.DOCUMENT_FRAGMENT_NODE:\n        object = this._ownerDocument.createDocumentFragment();\n        break;\n\n      default:\n        throw new core.DOMException(NOT_FOUND_ERR);\n        break;\n    }\n\n    if (typeof fn === \"function\") {\n      fn(this, object);\n    }\n\n    if (deep || this.nodeType === ATTRIBUTE_NODE) {\n      var clone = null;\n\n      for (var i = 0, len = this._childNodes.length; i < len; i++) {\n        clone = this._childNodes[i].cloneNode(true);\n\n        if (clone.nodeType === ATTRIBUTE_NODE) {\n          object.setAttributeNode(clone);\n        } else {\n          var readonly = object._readonly;\n          object._readonly = false;\n          object.appendChild(clone);\n          object._readonly = readonly;\n        }\n      }\n    }\n\n    return object;\n  },\n\n  /* returns void */\n  normalize: function () {\n    var prevChild, child, attr, i;\n\n    if (this._attributes && this._attributes.length) {\n      for (i = 0; i < this._attributes.length; i++) {\n        if (this._attributes[i]) {\n          attr = this._attributes[i].normalize();\n        }\n      }\n    }\n\n    for (i = 0; i < this._childNodes.length; i++) {\n      child = this._childNodes[i];\n\n      if (child.normalize) {\n        child.normalize();\n      } // Level2/core clean off empty nodes\n\n\n      if (child.nodeValue === \"\") {\n        this.removeChild(child);\n        i--;\n        continue;\n      }\n\n      if (i > 0) {\n        prevChild = this._childNodes[i - 1];\n\n        if (child.nodeType === TEXT_NODE && prevChild.nodeType === TEXT_NODE) {\n          // remove the child and decrement i\n          prevChild.appendData(child.nodeValue);\n          this.removeChild(child);\n          i--;\n        }\n      }\n    }\n  },\n  toString: function () {\n    var id = '';\n\n    if (this.id) {\n      id = '#' + this.id;\n    }\n\n    if (this.className) {\n      var classes = this.className.split(/\\s+/);\n\n      for (var i = 0, len = classes.length; i < len; i++) {\n        id += '.' + classes[i];\n      }\n    }\n\n    return '[ ' + this.tagName + id + ' ]';\n  },\n  raise: function (type, message, data) {\n    var text = type + \": \" + message;\n\n    if (data) {\n      if (data.exception) {\n        text = data.exception.stack;\n      } else {\n        text += ' - More:\\n' + data;\n      }\n    }\n\n    if (type === \"error\") {\n      if (!this.errors) {\n        this.errors = [];\n      } // TODO: consider using actual `Error` objects or `DOMException`s even..\n\n\n      var err = {\n        type: type,\n        message: message || \"No message\",\n        data: data || null\n      };\n      this.errors.push(err);\n\n      if (this._ownerDocument && this._ownerDocument.raise && this !== this._ownerDocument) {\n        this._ownerDocument.raise(type, message, data);\n      }\n    }\n  }\n};\n\ncore.NamedNodeMap = function NamedNodeMap(document) {\n  this._nodes = Object.create(null);\n  this._nsStore = {};\n  this.length = 0;\n  this._ownerDocument = document;\n  this._readonly = false;\n};\n\ncore.NamedNodeMap.prototype = {\n  get readonly() {\n    return this._readonly;\n  },\n\n  get ownerDocument() {\n    this._ownerDocument;\n  },\n\n  exists: function (name) {\n    return this._nodes[name] || this._nodes[name] === null ? true : false;\n  },\n\n  /* returns Node */\n  getNamedItem: function (\n  /* string */\n  name) {\n    return this._nodes[name] || null;\n  },\n\n  /* returns Node */\n  setNamedItem: function (\n  /* Node */\n  arg) {\n    // readonly\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    } // arg is from a different document\n\n\n    if (arg && arg._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    } // if this argument is already in use..\n\n\n    if (arg && arg._ownerElement) {\n      throw new core.DOMException(INUSE_ATTRIBUTE_ERR);\n    }\n\n    var name = arg.name || arg.tagName;\n    var ret = this._nodes[name];\n\n    if (!ret) {\n      this.length++;\n      ret = null;\n    }\n\n    this._nodes[name] = arg; // Avoid overwriting prototype methods etc.:\n\n    if (this.hasOwnProperty(name) || !(name in this)) {\n      this[name] = arg;\n    }\n\n    return ret;\n  },\n  // raises: function(DOMException) {},\n\n  /* returns Node */\n  removeNamedItem: function (\n  /* string */\n  name) {\n    // readonly\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (!this._nodes[name]) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    var prev = this._nodes[name] || null;\n    delete this._nodes[name];\n    delete this[name];\n    this.length--;\n    return prev;\n  },\n  // raises: function(DOMException) {},\n\n  /* returns Node */\n  item: function (\n  /* int */\n  index) {\n    var current = 0;\n\n    for (var member in this._nodes) {\n      if (current === index && this._nodes[member]) {\n        return this._nodes[member];\n      }\n\n      current++;\n    }\n\n    return null;\n  }\n}; //\n// For historical reasons, AttributeList objects must allow accessing\n// attributes as if the object were an associative array. For\n// instance, if `attributes` is an AttributeList object then\n// `attributes.x` should evaluate to the attribute named `x` (which is\n// not in any namespace). The AttributeList class uses the dollar\n// symbol ($) to reduce the possibility of a clash between its field\n// names and possible attribute names. For instance, if the method\n// currently named `$set` were instead named `set` then it would not\n// be possible to access an attribute named `set` through\n// `attributes.set`. The dollar symbol is not valid in attribute names\n// so `$set` cannot clash.\n//\n// Some fields do not get the $ because:\n//\n// * They are part of the API (e.g. `setNamedItem`, `length`), so they\n//   must be visible under a specific name.\n//\n// * Jsdom's code which traverses the DOM tree expects regularly named\n//   fields (e.g. `_parentNode`).\n//\n\nfunction AttributeList(document, parentNode) {\n  this._ownerDocument = document;\n  this._parentNode = parentNode;\n  this._readonly = false;\n  this._$ns_to_attrs = Object.create(null);\n  this._$name_to_attrs = Object.create(null);\n  this.length = 0;\n}\n\nAttributeList.prototype = {\n  _$reserved: [],\n  // Initialized later\n  //\n  // Code internal to jsdom and which manipulates an AttributeList\n  // object should use the following methods rather than the methods\n  // that provide the NamedNodeMap interface.\n  //\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $getNoNS: function (name) {\n    var attrs = this._$name_to_attrs[name];\n\n    if (!attrs) {\n      return null;\n    }\n\n    return attrs[0] || null;\n  },\n  $getNode: function (namespace, localName) {\n    var attrs = this._$ns_to_attrs[namespace];\n\n    if (!attrs) {\n      return null;\n    }\n\n    var ret = attrs[localName];\n\n    if (!ret) {\n      return null;\n    }\n\n    return ret;\n  },\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $setNoNS: function (name, value, dontValidate) {\n    var attr = this.$getNoNS(name);\n\n    if (!attr) {\n      this.$set(name, value, undefined, undefined, undefined, dontValidate);\n      return;\n    }\n\n    var prev_val = attr.value;\n    attr.value = value;\n\n    this._parentNode._attrModified(attr.name, attr.value, prev_val);\n\n    this._parentNode._modified();\n  },\n  $set: function (localName, value, name, prefix, namespace, dontValidate) {\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (name === undefined) {\n      name = localName;\n    }\n\n    if (prefix === undefined) {\n      prefix = null;\n    }\n\n    if (namespace === undefined) {\n      namespace = null;\n    }\n\n    var prev_attr = this.$getNode(namespace, localName);\n    var attr;\n    var prev_val = null;\n\n    if (prev_attr) {\n      prev_val = prev_attr.value;\n      prev_attr._prefix = prefix;\n      prev_attr.value = value;\n      attr = prev_attr;\n\n      this._parentNode._attrModified(attr.name, attr.value, prev_val);\n\n      this._parentNode._modified();\n    } else {\n      var method = dontValidate ? '_createAttributeNoNameValidation' : 'createAttribute';\n      attr = this._ownerDocument[method](name);\n      attr._ownerElement = this._parentNode;\n      attr.value = value;\n      attr._namespaceURI = namespace;\n      attr._prefix = prefix;\n      attr._localName = localName;\n      attr._parentNode = this._parentNode;\n      this.$setNode(attr); // $setNode calls the parent node methods.\n    }\n  },\n  $setNode: function (attr) {\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (attr.nodeType !== ATTRIBUTE_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    if (attr._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    }\n\n    if (attr._parentNode && attr._parentNode !== this._parentNode) {\n      throw new core.DOMException(INUSE_ATTRIBUTE_ERR);\n    }\n\n    var localName = attr._localName;\n    var name = attr.name;\n    var prefix = attr._prefix;\n    var namespace = attr._namespaceURI;\n\n    if (name === undefined) {\n      name = localName;\n    }\n\n    if (prefix === undefined) {\n      prefix = null;\n    }\n\n    if (namespace === undefined) {\n      namespace = null;\n    }\n\n    var prev_attr = this.$getNode(namespace, localName);\n    var prev_val = null;\n\n    if (prev_attr) {\n      prev_val = prev_attr.value; // Remove the old attribute\n\n      this._$onlyRemoveNode(prev_attr);\n    }\n\n    attr._parentNode = this._parentNode;\n    attr._ownerElement = this._parentNode;\n    var attrs = this._$ns_to_attrs[namespace];\n\n    if (!attrs) {\n      attrs = this._$ns_to_attrs[namespace] = Object.create(null);\n    }\n\n    attrs[localName] = attr;\n    attrs = this._$name_to_attrs[name];\n\n    if (!attrs) {\n      attrs = this._$name_to_attrs[name] = [attr];\n    } else {\n      attrs.push(attr);\n    } // Only attributes in the null namespace can be set this way.\n\n\n    if (namespace === null) {\n      // Make the node a field on this object but ONLY if it does not\n      // clash with the reserved names.\n      if (this._$reserved.indexOf(name) === -1) {\n        this[name] = attr;\n      }\n    }\n\n    this[this.length] = attr;\n    this.length++;\n\n    this._parentNode._attrModified(attr.name, attr.value, prev_val);\n\n    this._parentNode._modified();\n\n    return prev_attr;\n  },\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $removeNoNS: function (name) {\n    var attr = this.$getNoNS(name);\n    return attr ? this.$removeNode(attr) : null;\n  },\n  $remove: function (namespace, localName) {\n    var attr = this.$getNode(namespace, localName);\n    return attr ? this.$removeNode(attr) : null;\n  },\n\n  /* Only removes the node, and does not add a default value. */\n  _$onlyRemoveNode: function (attr) {\n    var namespace = attr._namespaceURI;\n    var localName = attr._localName;\n    var attrs = this._$ns_to_attrs[namespace];\n\n    if (!attrs) {\n      return null;\n    }\n\n    var found_attr = attrs[localName];\n\n    if (found_attr !== attr) {\n      return null;\n    }\n\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    attr._ownerElement = null;\n    attr._parentNode = null;\n    delete attrs[localName];\n    attrs = this._$name_to_attrs[attr.name];\n    attrs.splice(attrs.indexOf(attr), 1);\n    var ix = Array.prototype.indexOf.call(this, attr); // Splice also modifies length.\n\n    Array.prototype.splice.call(this, ix, 1);\n\n    if (this[attr.name] === attr) {\n      delete this[attr.name];\n    }\n\n    this._parentNode._attrModified(attr.name);\n\n    this._parentNode._modified();\n\n    return attr;\n  },\n  $removeNode: function (attr) {\n    if (!this._$onlyRemoveNode(attr)) {\n      return null;\n    }\n\n    return attr;\n  },\n  // Although http://dom.spec.whatwg.org/#concept-element-attribute\n  // does not specify that the attributes field on an Element should\n  // support NamedNodeMap, in practice browsers still support this\n  // interface so we should support it for compatibility.\n  getNamedItem: function (name) {\n    return this.getNamedItemNS(null, name);\n  },\n  removeNamedItem: function (name) {\n    return this.removeNamedItemNS(null, name);\n  },\n  item: function (i) {\n    return this[i];\n  },\n  getNamedItemNS: function (namespaceURI, localName) {\n    if (namespaceURI === \"\") {\n      namespaceURI = null;\n    }\n\n    return this.$getNode(namespaceURI, localName);\n  },\n  removeNamedItemNS: function (namespaceURI, localName) {\n    var ret = this.$remove(namespaceURI, localName);\n\n    if (ret === null) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    return ret;\n  }\n}; // Alias these methods.\n\nAttributeList.prototype.setNamedItem = AttributeList.prototype.$setNode;\nAttributeList.prototype.setNamedItemNS = AttributeList.prototype.$setNode;\n\n(function () {\n  // Construct the list of reserved attribute names from a temporarily\n  // created AttributeList and from the chain of prototypes. We need\n  // this because JavaScript code running an a browser expects to be\n  // able to do el.attributes.x to get the value of the attribute \"x\"\n  // on an element. Unfortunately, JavaScript *currently* does not\n  // allow us to elegantly provide such functionality without risking\n  // a clash with the fields and methods set on the AttributeList\n  // object. Hence we need a list of reserved field names.\n  var reserved = Object.keys(new AttributeList());\n  var prototype = AttributeList.prototype;\n\n  while (prototype) {\n    reserved = reserved.concat(Object.getOwnPropertyNames(prototype));\n    prototype = Object.getPrototypeOf(prototype);\n  }\n\n  AttributeList.prototype._$reserved = reserved;\n})();\n\ncore.AttributeList = AttributeList;\n\ncore.Element = function Element(document, localName) {\n  core.Node.call(this, document);\n  this._namespaceURI = null;\n  this._prefix = null;\n  this._localName = localName;\n};\n\ninheritFrom(core.Node, core.Element, {\n  get namespaceURI() {\n    return this._namespaceURI;\n  },\n\n  get prefix() {\n    return this._prefix;\n  },\n\n  get localName() {\n    return this._localName;\n  },\n\n  get tagName() {\n    var qualifiedName = this._prefix !== null ? this._prefix + \":\" + this._localName : this._localName;\n\n    if (this.namespaceURI === \"http://www.w3.org/1999/xhtml\" && this._ownerDocument._parsingMode === \"html\") {\n      qualifiedName = qualifiedName.toUpperCase();\n    }\n\n    return qualifiedName;\n  },\n\n  get id() {\n    var idAttr = this.getAttribute(\"id\");\n\n    if (idAttr === null) {\n      return \"\";\n    }\n\n    return idAttr;\n  },\n\n  nodeType: ELEMENT_NODE,\n\n  get attributes() {\n    return this._attributes;\n  },\n\n  get sourceIndex() {\n    /*\n    * According to QuirksMode:\n    * Get the sourceIndex of element x. This is also the index number for\n    * the element in the document.getElementsByTagName('*') array.\n    * http://www.quirksmode.org/dom/w3c_core.html#t77\n    */\n    var items = this.ownerDocument.getElementsByTagName('*'),\n        len = items.length;\n\n    for (var i = 0; i < len; i++) {\n      if (items[i] === this) {\n        return i;\n      }\n    }\n  },\n\n  get outerHTML() {\n    return domToHtml(this, true);\n  },\n\n  get innerHTML() {\n    var tagName = this.tagName;\n\n    if (tagName === 'SCRIPT' || tagName === 'STYLE') {\n      var type = this.getAttribute('type');\n\n      if (!type || /^text\\//i.test(type) || /\\/javascript$/i.test(type)) {\n        return domToHtml(this._childNodes, true, true);\n      }\n    } // In case of <template> we should pass it's content fragment as a serialization root if we have one\n\n\n    if (tagName === 'TEMPLATE' && this._namespaceURI === 'http://www.w3.org/1999/xhtml' && this._childNodes[0] && this._childNodes[0]._templateContent) {\n      return domToHtml(this._childNodes[0]._childNodes, true);\n    }\n\n    return domToHtml(this._childNodes, true);\n  },\n\n  set innerHTML(html) {\n    setInnerHTML(this.ownerDocument, this, html);\n  },\n\n  scrollTop: 0,\n  scrollLeft: 0,\n  hasAttributes: function () {\n    return this._attributes.length > 0;\n  },\n\n  /* returns Attr */\n  setAttributeNode: function (\n  /* Attr */\n  newAttr) {\n    var prevNode = this._attributes.$getNode(null, newAttr.name);\n\n    if (prevNode) {\n      prevNode._ownerElement = null;\n    }\n\n    newAttr._ownerElement = this;\n\n    this._attributes.$setNode(newAttr);\n\n    return prevNode && prevNode.specified ? prevNode : null;\n  },\n  //  raises: function(DOMException) {},\n\n  /* returns Attr */\n  removeAttributeNode: function (\n  /* Attr */\n  oldAttr) {\n    var ret = this._attributes.$removeNode(oldAttr);\n\n    if (ret !== null) {\n      return ret;\n    }\n\n    throw new core.DOMException(NOT_FOUND_ERR);\n  },\n  //raises: function(DOMException) {},\n\n  /* returns NodeList */\n  getElementsByTagName: memoizeQuery(function (\n  /* string */\n  name) {\n    name = name.toLowerCase();\n\n    function filterByTagName(child) {\n      if (child.nodeName && child.nodeType === ELEMENT_NODE) {\n        return name === \"*\" || child.nodeName.toLowerCase() === name;\n      }\n\n      return false;\n    }\n\n    return new core.NodeList(this._ownerDocument || this, core.mapper(this, filterByTagName, true));\n  }),\n  getElementsByClassName: function (className) {\n    function filterByClassName(child) {\n      if (!child) {\n        return false;\n      }\n\n      var classString = child.className;\n\n      if (classString) {\n        var s = classString.split(\" \");\n\n        for (var i = 0; i < s.length; i++) {\n          if (s[i] === className) {\n            return true;\n          }\n        }\n      }\n\n      return false;\n    }\n\n    return new core.NodeList(this.ownerDocument || this, core.mapper(this, filterByClassName));\n  }\n});\n\ncore.DocumentFragment = function DocumentFragment(document) {\n  core.Node.call(this, document);\n};\n\ninheritFrom(core.Node, core.DocumentFragment, {\n  nodeType: DOCUMENT_FRAGMENT_NODE\n});\n\ncore.Document = function Document(options) {\n  if (!options || !options.parsingMode || options.parsingMode !== \"html\" && options.parsingMode !== \"xml\") {\n    throw new Error(\"options must exist and contain a parsingMode of html or xml\");\n  }\n\n  core.Node.call(this, \"#document\");\n  this._parsingMode = options.parsingMode;\n  this._implementation = new core.DOMImplementation(this);\n  this._documentElement = null;\n  this._ids = Object.create(null);\n  this._attached = true;\n  this._ownerDocument = this;\n  this._readonly = false;\n  this._contentType = options.contentType;\n\n  if (this._contentType === undefined) {\n    this._contentType = this._parsingMode === \"xml\" ? \"application/xml\" : \"text/html\";\n  }\n\n  this._URL = options.url;\n\n  if (this._URL === undefined) {\n    this._URL = \"about:blank\";\n  }\n\n  this._location = new Location(this._URL, this);\n};\n\nvar tagRegEx = /[^\\w:\\d_\\.-]+/i;\nvar entRegEx = /[^\\w\\d_\\-&;]+/;\nvar invalidAttrRegEx = /[\\s\"'>/=\\u0000-\\u001A]/;\ninheritFrom(core.Node, core.Document, {\n  nodeType: DOCUMENT_NODE,\n  _elementBuilders: {},\n  _defaultElementBuilder: function (document, tagName) {\n    return new core.Element(document, tagName);\n  },\n\n  get contentType() {\n    return this._contentType;\n  },\n\n  get compatMode() {\n    return this._parsingMode === \"xml\" || this.doctype ? \"CSS1Compat\" : \"BackCompat\";\n  },\n\n  get characterSet() {\n    return \"UTF-8\";\n  },\n\n  get inputEncoding() {\n    return \"UTF-8\";\n  },\n\n  get doctype() {\n    for (var i = 0; i < this._childNodes.length; ++i) {\n      if (this._childNodes[i].nodeType === DOCUMENT_TYPE_NODE) {\n        return this._childNodes[i];\n      }\n    }\n\n    return null;\n  },\n\n  get URL() {\n    return this._URL;\n  },\n\n  get documentURI() {\n    return this._URL;\n  },\n\n  get location() {\n    return this._location;\n  },\n\n  get documentElement() {\n    if (this._documentElement) {\n      return this._documentElement;\n    } else {\n      for (var i = 0; i < this._childNodes.length; ++i) {\n        if (this._childNodes[i].nodeType === ELEMENT_NODE) {\n          this._documentElement = this._childNodes[i];\n          return this._documentElement;\n        }\n      }\n\n      return null;\n    }\n  },\n\n  get implementation() {\n    return this._implementation;\n  },\n\n  set implementation(implementation) {\n    this._implementation = implementation;\n  },\n\n  get ownerDocument() {\n    return null;\n  },\n\n  get readonly() {\n    return this._readonly;\n  },\n\n  set parentWindow(window) {\n    // Contextify does not support getters and setters, so we have to set them\n    // on the original object instead.\n    window._frame = function (name, frame) {\n      if (typeof frame === 'undefined') {\n        delete window[name];\n      } else {\n        defineGetter(window, name, function () {\n          return frame.contentWindow;\n        });\n      }\n    };\n\n    this._parentWindow = window.getGlobal();\n  },\n\n  get defaultView() {\n    return this.parentWindow;\n  },\n\n  toString: function () {\n    return '[object HTMLDocument]';\n  },\n  _createElementNoTagNameValidation: function (tagName) {\n    var element = (this._elementBuilders[tagName.toLowerCase()] || this._defaultElementBuilder)(this, tagName);\n\n    element._namespaceURI = \"http://www.w3.org/1999/xhtml\";\n    return element;\n  },\n  createElement: function (localName) {\n    localName = String(localName);\n    validateName(localName, core);\n\n    if (this._parsingMode === \"html\") {\n      localName = localName.toLowerCase();\n    }\n\n    return this._createElementNoTagNameValidation(localName);\n  },\n\n  /* returns DocumentFragment */\n  createDocumentFragment: function () {\n    return new core.DocumentFragment(this);\n  },\n\n  /* returns Attr */\n  createAttribute: function (localName) {\n    localName = String(localName);\n    validateName(localName, core);\n    return this._createAttributeNoNameValidation(localName);\n  },\n  // raises: function(DOMException) {},\n  _createAttributeNoNameValidation: function (localName) {\n    return new core.Attr(this, localName, \"\");\n  },\n  appendChild: function (\n  /* Node */\n  arg) {\n    if (this.documentElement && arg.nodeType == ELEMENT_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    return core.Node.prototype.appendChild.call(this, arg);\n  },\n  removeChild: function (\n  /* Node */\n  arg) {\n    var ret = core.Node.prototype.removeChild.call(this, arg);\n\n    if (arg == this._documentElement) {\n      this._documentElement = null; // force a recalculation\n    }\n\n    return ret;\n  },\n\n  /* returns NodeList */\n  getElementsByTagName: memoizeQuery(function (\n  /* string */\n  name) {\n    function filterByTagName(child) {\n      if (child.nodeName && child.nodeType === ELEMENT_NODE) {\n        if (name === \"*\") {\n          return true; // case insensitivity for html\n        } else if (child._ownerDocument && child._ownerDocument._doctype && //child._ownerDocument._doctype.name === \"html\" &&\n        child.nodeName.toLowerCase() === name.toLowerCase()) {\n          return true;\n        } else if (child.nodeName.toLowerCase() === name.toLowerCase()) {\n          return true;\n        }\n      }\n\n      return false;\n    }\n\n    return new core.NodeList(this.documentElement || this, core.mapper(this, filterByTagName, true));\n  }),\n  getElementsByClassName: function (className) {\n    function filterByClassName(child) {\n      if (!child) {\n        return false;\n      }\n\n      var classString = child.className;\n\n      if (classString) {\n        var s = classString.split(\" \");\n\n        for (var i = 0; i < s.length; i++) {\n          if (s[i] === className) {\n            return true;\n          }\n        }\n      }\n\n      return false;\n    }\n\n    return new core.NodeList(this.ownerDocument || this, core.mapper(this, filterByClassName));\n  },\n  write: function (text) {\n    if (this._writeAfterElement) {\n      // If called from an script element directly (during the first tick),\n      // the new elements are inserted right after that element.\n      var tempDiv = this.createElement('div');\n      setInnerHTML(this, tempDiv, text);\n      var child = tempDiv.firstChild;\n      var previous = this._writeAfterElement;\n      var parent = this._writeAfterElement.parentNode;\n\n      while (child) {\n        var node = child;\n        child = child.nextSibling;\n        parent.insertBefore(node, previous.nextSibling);\n        previous = node;\n      }\n    } else if (this.readyState === \"loading\") {\n      // During page loading, document.write appends to the current element\n      // Find the last child that has been added to the document.\n      var node = this;\n\n      while (node.lastChild && node.lastChild.nodeType === this.ELEMENT_NODE) {\n        node = node.lastChild;\n      }\n\n      setInnerHTML(this, node, text || \"<html><head></head><body></body></html>\");\n    } else if (text) {\n      setInnerHTML(this, this, text);\n    }\n  }\n});\n\ncore.Attr = function Attr(document, name, value) {\n  core.Node.call(this, document);\n  this._valueForAttrModified = value;\n  this._name = name;\n  this._ownerElement = null;\n  this._namespaceURI = null;\n  this._localName = name;\n  this._prefix = null;\n};\n\ninheritFrom(core.Node, core.Attr, {\n  nodeType: ATTRIBUTE_NODE,\n\n  get namespaceURI() {\n    return this._namespaceURI;\n  },\n\n  get prefix() {\n    return this._prefix;\n  },\n\n  get localName() {\n    return this._localName;\n  },\n\n  get name() {\n    return this._name;\n  },\n\n  get ownerElement() {\n    return this._ownerElement;\n  },\n\n  get nodeValue() {\n    var val = '';\n\n    for (var i = 0, len = this._childNodes.length; i < len; i++) {\n      var child = this._childNodes[i];\n      val += child.nodeValue;\n    }\n\n    return val;\n  },\n\n  set nodeValue(value) {\n    // readonly\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    this._childNodes.length = 1;\n    this._childNodes[0] = this._ownerDocument.createTextNode(value);\n\n    this._modified();\n\n    var prev = this._valueForAttrModified;\n    this._nodeValue = value;\n\n    if (this._ownerElement) {\n      this._ownerElement._attrModified(this._name, value, prev);\n    }\n  },\n\n  get specified() {\n    return true;\n  },\n\n  get value() {\n    return this.nodeValue;\n  },\n\n  set value(value) {\n    this.nodeValue = value;\n  },\n\n  get parentNode() {\n    return null;\n  },\n\n  insertBefore: function (\n  /* Node */\n  newChild,\n  /* Node*/\n  refChild) {\n    if (newChild.nodeType === CDATA_SECTION_NODE || newChild.nodeType === ELEMENT_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    return core.Node.prototype.insertBefore.call(this, newChild, refChild);\n  },\n  appendChild: function (\n  /* Node */\n  arg) {\n    if (arg.nodeType === CDATA_SECTION_NODE || arg.nodeType === ELEMENT_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    return core.Node.prototype.appendChild.call(this, arg);\n  }\n});","map":{"version":3,"sources":["F:/JavaScript/Projects/chemistryphile/node_modules/jsdom-no-contextify/lib/jsdom/level1/core.js"],"names":["inheritFrom","require","domToHtml","defineGetter","memoizeQuery","validateName","name","Location","attachId","id","elm","doc","_ids","push","detachId","elms","i","length","splice","setInnerHTML","dom","node","html","child","_childNodes","removeChild","isDoc","nodeName","_htmlToDom","appendHtmlToDocument","appendHtmlToElement","core","module","exports","mapper","parent","filter","recursive","mapDOMNodes","callback","visit","result","reduce","reducer","array","visitTree","root","cur","el","children","l","markTreeReadonly","markLevel","_readonly","attributes","INDEX_SIZE_ERR","DOMSTRING_SIZE_ERR","HIERARCHY_REQUEST_ERR","WRONG_DOCUMENT_ERR","INVALID_CHARACTER_ERR","NO_DATA_ALLOWED_ERR","NO_MODIFICATION_ALLOWED_ERR","NOT_FOUND_ERR","NOT_SUPPORTED_ERR","INUSE_ATTRIBUTE_ERR","INVALID_STATE_ERR","SYNTAX_ERR","INVALID_MODIFICATION_ERR","NAMESPACE_ERR","INVALID_ACCESS_ERR","ELEMENT_NODE","ATTRIBUTE_NODE","TEXT_NODE","CDATA_SECTION_NODE","ENTITY_REFERENCE_NODE","ENTITY_NODE","PROCESSING_INSTRUCTION_NODE","COMMENT_NODE","DOCUMENT_NODE","DOCUMENT_TYPE_NODE","DOCUMENT_FRAGMENT_NODE","NOTATION_NODE","messages","exceptionMessages","DOMException","code","message","Error","call","captureStackTrace","NodeList","element","query","Array","isArray","prototype","apply","Object","defineProperties","_length","value","writable","_element","_query","_snapshot","_version","_update","lengthFromProperties","arrayLike","max","keys","highestKeyIndex","asNumber","isNaN","nodes","_resetTo","startingLength","j","_toArray","slice","item","index","toString","defineProperty","configurable","DOMImplementation","document","features","_ownerDocument","_features","feature","hasOwnProperty","_addFeature","toLowerCase","_removeFeature","version","versions","_hasFeature","indexOf","found","RegExp","test","attrCopy","src","dest","fn","attrs","attr","copied","specified","namespaceURI","setAttributeNS","localName","split","pop","getAttributeNodeNS","setAttribute","getAttributeNode","Node","ownerDocument","_childNodesList","_attributes","AttributeList","_childrenList","_parentNode","_memoizedQueries","self","tagName","nodeValue","nodeType","_data","replaceData","parentNode","target","unused","firstChild","readonly","lastChild","len","childNodes","_indexOf","nextSibling","previousSibling","insertBefore","newChild","refChild","Document","current","_templateContent","tmpNode","refChildIndex","_attached","_attach","_modified","_descendantAdded","_clearMemoizedQueries","_descendantRemoved","_attrModified","oldValue","w","run","parentWindow","event","__tempContextForInlineEventHandler","__tempEvent","replaceChild","oldChild","_detach","oldChildIndex","lastIndexOf","appendChild","hasChildNodes","cloneNode","deep","object","createElementNS","_prefix","_localName","createTextNode","createAttribute","pi","createProcessingInstruction","_target","createComment","constructor","parsingMode","_parsingMode","DocumentType","_name","_publicId","_systemId","createDocumentFragment","clone","setAttributeNode","normalize","prevChild","appendData","className","classes","raise","type","data","text","exception","stack","errors","err","NamedNodeMap","_nodes","create","_nsStore","exists","getNamedItem","setNamedItem","arg","_ownerElement","ret","removeNamedItem","prev","member","_$ns_to_attrs","_$name_to_attrs","_$reserved","$getNoNS","$getNode","namespace","$setNoNS","dontValidate","$set","undefined","prev_val","prefix","prev_attr","method","_namespaceURI","$setNode","_$onlyRemoveNode","$removeNoNS","$removeNode","$remove","found_attr","ix","getNamedItemNS","removeNamedItemNS","setNamedItemNS","reserved","concat","getOwnPropertyNames","getPrototypeOf","Element","qualifiedName","toUpperCase","idAttr","getAttribute","sourceIndex","items","getElementsByTagName","outerHTML","innerHTML","scrollTop","scrollLeft","hasAttributes","newAttr","prevNode","removeAttributeNode","oldAttr","filterByTagName","getElementsByClassName","filterByClassName","classString","s","DocumentFragment","options","_implementation","_documentElement","_contentType","contentType","_URL","url","_location","tagRegEx","entRegEx","invalidAttrRegEx","_elementBuilders","_defaultElementBuilder","compatMode","doctype","characterSet","inputEncoding","URL","documentURI","location","documentElement","implementation","window","_frame","frame","contentWindow","_parentWindow","getGlobal","defaultView","_createElementNoTagNameValidation","createElement","String","_createAttributeNoNameValidation","Attr","_doctype","write","_writeAfterElement","tempDiv","previous","readyState","_valueForAttrModified","ownerElement","val","_nodeValue"],"mappings":"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","sourcesContent":["/*\n  ServerJS Javascript DOM Level 1\n*/\nvar inheritFrom = require(\"../utils\").inheritFrom;\nvar domToHtml = require(\"../browser/domtohtml\").domToHtml;\nvar defineGetter = require(\"../utils\").defineGetter;\nvar memoizeQuery = require(\"../utils\").memoizeQuery;\nvar validateName = require('../living/helpers/validate-names').name;\nvar Location = require(\"../browser/location\");\n\n// utility functions\nvar attachId = function(id,elm,doc) {\n  if (id && elm && doc) {\n    if (!doc._ids[id]) {\n      doc._ids[id] = [];\n    }\n    doc._ids[id].push(elm);\n  }\n};\nvar detachId = function(id,elm,doc) {\n  var elms, i;\n  if (id && elm && doc) {\n    if (doc._ids && doc._ids[id]) {\n      elms = doc._ids[id];\n      for (i=0;i<elms.length;i++) {\n        if (elms[i] === elm) {\n          elms.splice(i,1);\n          i--;\n        }\n      }\n      if (elms.length === 0) {\n        delete doc._ids[id];\n      }\n    }\n  }\n};\n\nfunction setInnerHTML(dom, node, html) {\n  //Clear the children first:\n  var child;\n  while ((child = node._childNodes[0])) {\n    node.removeChild(child);\n  }\n\n  var isDoc = node.nodeName === '#document';\n  if (html !== \"\" && html != null) {\n    if (isDoc) {\n      dom._htmlToDom.appendHtmlToDocument(html, node);\n    } else {\n      dom._htmlToDom.appendHtmlToElement(html, node);\n    }\n  }\n}\n\n// TODO: move all of these to utils.js. Right now they are exposed on window, which is bizarre.\nvar core = module.exports = {\n  mapper: function(parent, filter, recursive) {\n    return function() {\n      return core.mapDOMNodes(parent, recursive !== false, filter);\n    };\n  },\n\n  // Returns Array\n  mapDOMNodes : function(parent, recursive, callback) {\n    function visit(parent, result) {\n      return parent._childNodes.reduce(reducer, result);\n    }\n\n    function reducer(array, child) {\n      if (callback(child)) {\n        array.push(child);\n      }\n      if (recursive && child._childNodes) {\n        visit(child, array);\n      }\n      return array;\n    }\n\n    return visit(parent, []);\n  },\n\n  visitTree: function(root, callback) {\n    var cur = root; // TODO: Unroll this.\n\n    function visit(el) {\n      if (el) {\n        callback(el);\n        if (el._childNodes) {\n          var i        = 0,\n              children = el._childNodes,\n              l        = children.length;\n\n          for (i; i<l; i++) {\n            visit(children[i]);\n          }\n        }\n      }\n    }\n    visit(root);\n  },\n\n  markTreeReadonly: function(node) {\n    function markLevel(el) {\n      el._readonly = true;\n      // also mark attributes and their children read-only\n      if (el.attributes) {\n        var attributes = el.attributes, l = attributes.length, i=0;\n        attributes._readonly = true;\n\n        for (i; i<l; i++) {\n          core.visitTree(attributes[i], markLevel);\n        }\n      }\n    }\n\n    core.visitTree(node, markLevel);\n  }\n};\n\n// ExceptionCode\nvar INDEX_SIZE_ERR              = core.INDEX_SIZE_ERR              = 1,\n    DOMSTRING_SIZE_ERR          = core.DOMSTRING_SIZE_ERR          = 2,\n    HIERARCHY_REQUEST_ERR       = core.HIERARCHY_REQUEST_ERR       = 3,\n    WRONG_DOCUMENT_ERR          = core.WRONG_DOCUMENT_ERR          = 4,\n    INVALID_CHARACTER_ERR       = core.INVALID_CHARACTER_ERR       = 5,\n    NO_DATA_ALLOWED_ERR         = core.NO_DATA_ALLOWED_ERR         = 6,\n    NO_MODIFICATION_ALLOWED_ERR = core.NO_MODIFICATION_ALLOWED_ERR = 7,\n    NOT_FOUND_ERR               = core.NOT_FOUND_ERR               = 8,\n    NOT_SUPPORTED_ERR           = core.NOT_SUPPORTED_ERR           = 9,\n    INUSE_ATTRIBUTE_ERR         = core.INUSE_ATTRIBUTE_ERR         = 10,\n    INVALID_STATE_ERR           = core.INVALID_STATE_ERR           = 11,\n    SYNTAX_ERR                  = core.SYNTAX_ERR                  = 12,\n    INVALID_MODIFICATION_ERR    = core.INVALID_MODIFICATION_ERR    = 13,\n    NAMESPACE_ERR               = core.NAMESPACE_ERR               = 14,\n    INVALID_ACCESS_ERR          = core.INVALID_ACCESS_ERR          = 15,\n// Node Types\n    ELEMENT_NODE                = 1,\n    ATTRIBUTE_NODE              = 2,\n    TEXT_NODE                   = 3,\n    CDATA_SECTION_NODE          = 4,\n    ENTITY_REFERENCE_NODE       = 5,\n    ENTITY_NODE                 = 6,\n    PROCESSING_INSTRUCTION_NODE = 7,\n    COMMENT_NODE                = 8,\n    DOCUMENT_NODE               = 9,\n    DOCUMENT_TYPE_NODE          = 10,\n    DOCUMENT_FRAGMENT_NODE      = 11,\n    NOTATION_NODE               = 12;\n\nvar messages = core.exceptionMessages = { };\nmessages[INDEX_SIZE_ERR]              = \"Index size error\";\nmessages[DOMSTRING_SIZE_ERR]          = \"DOMString size error\";\nmessages[HIERARCHY_REQUEST_ERR]       = \"Hierarchy request error\";\nmessages[WRONG_DOCUMENT_ERR]          = \"Wrong document\";\nmessages[INVALID_CHARACTER_ERR]       = \"Invalid character\";\nmessages[NO_DATA_ALLOWED_ERR]         = \"No data allowed\";\nmessages[NO_MODIFICATION_ALLOWED_ERR] = \"No modification allowed\";\nmessages[NOT_FOUND_ERR]               = \"Not found\";\nmessages[NOT_SUPPORTED_ERR]           = \"Not supported\";\nmessages[INUSE_ATTRIBUTE_ERR]         = \"Attribute in use\";\nmessages[NAMESPACE_ERR]               = \"Invalid namespace\";\n\ncore.DOMException = function DOMException(code, message) {\n  Error.call(this, core.exceptionMessages[code]);\n  this.message = core.exceptionMessages[code];\n  this.code = code;\n\n  if (message) {\n    this.message = this.message + \": \" + message;\n  }\n\n  if (Error.captureStackTrace) {\n\n    Error.captureStackTrace(this, DOMException);\n  }\n};\n\ncore.DOMException.INDEX_SIZE_ERR              = INDEX_SIZE_ERR;\ncore.DOMException.DOMSTRING_SIZE_ERR          = DOMSTRING_SIZE_ERR;\ncore.DOMException.HIERARCHY_REQUEST_ERR       = HIERARCHY_REQUEST_ERR;\ncore.DOMException.WRONG_DOCUMENT_ERR          = WRONG_DOCUMENT_ERR;\ncore.DOMException.INVALID_CHARACTER_ERR       = INVALID_CHARACTER_ERR;\ncore.DOMException.NO_DATA_ALLOWED_ERR         = NO_DATA_ALLOWED_ERR;\ncore.DOMException.NO_MODIFICATION_ALLOWED_ERR = NO_MODIFICATION_ALLOWED_ERR;\ncore.DOMException.NOT_FOUND_ERR               = NOT_FOUND_ERR;\ncore.DOMException.NOT_SUPPORTED_ERR           = NOT_SUPPORTED_ERR;\ncore.DOMException.INUSE_ATTRIBUTE_ERR         = INUSE_ATTRIBUTE_ERR;\ncore.DOMException.INVALID_STATE_ERR           = INVALID_STATE_ERR;\ncore.DOMException.SYNTAX_ERR                  = SYNTAX_ERR;\ncore.DOMException.INVALID_MODIFICATION_ERR    = INVALID_MODIFICATION_ERR;\ncore.DOMException.NAMESPACE_ERR               = NAMESPACE_ERR;\ncore.DOMException.INVALID_ACCESS_ERR          = INVALID_ACCESS_ERR;\n\ninheritFrom(Error, core.DOMException, {\n  name: \"DOMException\",\n  INDEX_SIZE_ERR              : INDEX_SIZE_ERR,\n  DOMSTRING_SIZE_ERR          : DOMSTRING_SIZE_ERR,\n  HIERARCHY_REQUEST_ERR       : HIERARCHY_REQUEST_ERR,\n  WRONG_DOCUMENT_ERR          : WRONG_DOCUMENT_ERR,\n  INVALID_CHARACTER_ERR       : INVALID_CHARACTER_ERR,\n  NO_DATA_ALLOWED_ERR         : NO_DATA_ALLOWED_ERR,\n  NO_MODIFICATION_ALLOWED_ERR : NO_MODIFICATION_ALLOWED_ERR,\n  NOT_FOUND_ERR               : NOT_FOUND_ERR,\n  NOT_SUPPORTED_ERR           : NOT_SUPPORTED_ERR,\n  INUSE_ATTRIBUTE_ERR         : INUSE_ATTRIBUTE_ERR,\n  INVALID_STATE_ERR           : INVALID_STATE_ERR,\n  SYNTAX_ERR                  : SYNTAX_ERR,\n  INVALID_MODIFICATION_ERR    : INVALID_MODIFICATION_ERR,\n  NAMESPACE_ERR               : NAMESPACE_ERR,\n  INVALID_ACCESS_ERR          : INVALID_ACCESS_ERR\n});\n\ncore.NodeList = function NodeList(element, query) {\n  if (!query) {\n    // Non-live NodeList\n    if (Array.isArray(element)) {\n      Array.prototype.push.apply(this, element);\n    }\n    Object.defineProperties(this, {\n      _length: {value: element ? element.length : 0, writable:true}\n    });\n  } else {\n    Object.defineProperties(this, {\n      _element: {value: element},\n      _query: {value: query},\n      _snapshot: {writable: true},\n      _length: {value: 0, writable: true},\n      _version: {value: -1, writable: true}\n    });\n    this._update();\n  }\n};\n\nfunction lengthFromProperties(arrayLike) {\n  var max = -1;\n  var keys = Object.keys(arrayLike);\n  var highestKeyIndex = keys.length - 1;\n\n  // abuses a v8 implementation detail for a very fast case\n  // (if this implementation detail changes, this method will still\n  //  return correct results)\n  if (highestKeyIndex == keys[highestKeyIndex]) { // not ===\n    return keys.length;\n  }\n\n  for (var i = highestKeyIndex; i >= 0 ; --i) {\n    var asNumber = + keys[i];\n\n    if (!isNaN(asNumber) && asNumber > max) {\n      max = asNumber;\n    }\n  }\n  return max + 1;\n}\ncore.NodeList.prototype = {\n  _update: function() {\n    var i;\n\n    if (!this._element) {\n      this._length = lengthFromProperties(this);\n    } else {\n      if (this._version < this._element._version) {\n        var nodes = this._snapshot = this._query();\n        this._resetTo(nodes);\n        this._version = this._element._version;\n      }\n    }\n  },\n  _resetTo: function(array) {\n    var startingLength = lengthFromProperties(this);\n    for (var i = 0; i < startingLength; ++i) {\n      delete this[i];\n    }\n\n    for (var j = 0; j < array.length; ++j) {\n      this[j] = array[j];\n    }\n    this._length = array.length;\n  },\n  _toArray: function() {\n    if (this._element) {\n      this._update();\n      return this._snapshot;\n    }\n\n    return Array.prototype.slice.call(this);\n  },\n  get length() {\n    this._update();\n    return this._length || 0;\n  },\n  set length(length) {\n    return this._length;\n  },\n  item: function(index) {\n    this._update();\n    return this[index] || null;\n  },\n  toString: function() {\n    return '[ jsdom NodeList ]: contains ' + this.length + ' items';\n  }\n};\nObject.defineProperty(core.NodeList.prototype, 'constructor', {\n  value: core.NodeList,\n  writable: true,\n  configurable: true\n});\n\ncore.DOMImplementation = function DOMImplementation(document, /* Object */ features) {\n  this._ownerDocument = document;\n  this._features = {};\n\n  if (features) {\n    for (var feature in features) {\n      if (features.hasOwnProperty(feature)) {\n        this._addFeature(feature.toLowerCase(), features[feature]);\n      }\n    }\n  }\n};\n\ncore.DOMImplementation.prototype = {\n  // All of these are legacy, left because jsdom uses them internally :(. jsdom confused the idea of browser features\n  // and jsdom features\n  _removeFeature : function(feature, version) {\n    feature = feature.toLowerCase();\n    if (this._features[feature]) {\n      if (version) {\n        var j        = 0,\n            versions = this._features[feature],\n            l        = versions.length;\n\n        for (j; j<l; j++) {\n          if (versions[j] === version) {\n            versions.splice(j,1);\n            return;\n          }\n        }\n      } else {\n        delete this._features[feature];\n      }\n    }\n  },\n\n  _addFeature: function(feature, version) {\n    feature = feature.toLowerCase();\n\n    if (version) {\n\n      if (!this._features[feature]) {\n        this._features[feature] = [];\n      }\n\n      if (version instanceof Array) {\n        Array.prototype.push.apply(this._features[feature], version);\n      } else {\n        this._features[feature].push(version);\n      }\n    }\n  },\n\n  // The real hasFeature is in living/dom-implementation.js, and returns true always.\n  // This one is used internally\n  _hasFeature: function(/* string */ feature, /* string */ version) {\n    feature = (feature) ? feature.toLowerCase() : '';\n    var versions = (this._features[feature]) ?\n                    this._features[feature]  :\n                    false;\n\n    if (!version && versions.length && versions.length > 0) {\n      return true;\n    } else if (typeof versions === 'string') {\n      return versions === version;\n    } else if (versions.indexOf && versions.length > 0) {\n      for (var i = 0; i < versions.length; i++) {\n        var found = versions[i] instanceof RegExp ?\n          versions[i].test(version) :\n          versions[i] === version;\n        if (found) { return true; }\n      }\n      return false;\n    } else {\n      return false;\n    }\n  }\n};\n\n\nvar attrCopy = function(src, dest, fn) {\n  if (src.attributes) {\n    var attrs = src.attributes, i, l = attrs.length, attr, copied;\n    for (i=0;i<l;i++) {\n      attr = attrs[i];\n      // skip over default attributes\n      if (!attr.specified) {\n        continue;\n      }\n      // TODO: consider duplicating this code and moving it into level2/core\n      if (attr.namespaceURI) {\n        dest.setAttributeNS(attr.namespaceURI,\n                                     attr.name,\n                                     attr.value);\n        var localName = attr.name.split(':').pop();\n        copied = dest.getAttributeNodeNS(attr.namespaceURI, localName);\n      } else {\n        dest.setAttribute(attr.name, attr.value);\n        copied = dest.getAttributeNode(attr.name);\n      }\n      if (typeof fn == \"function\") {\n        fn(attr, copied);\n      }\n\n    }\n  }\n  return dest;\n};\n\ncore.Node = function Node(ownerDocument) {\n  this._childNodes = [];\n  this._childNodesList = null;\n  this._ownerDocument = ownerDocument;\n  this._attributes = new AttributeList(ownerDocument, this);\n  this._childrenList = null;\n  this._version = 0;\n  this._parentNode = null;\n  this._memoizedQueries = {};\n  this._readonly = false;\n};\n\ncore.Node.ELEMENT_NODE                = ELEMENT_NODE;\ncore.Node.ATTRIBUTE_NODE              = ATTRIBUTE_NODE;\ncore.Node.TEXT_NODE                   = TEXT_NODE;\ncore.Node.CDATA_SECTION_NODE          = CDATA_SECTION_NODE;\ncore.Node.ENTITY_REFERENCE_NODE       = ENTITY_REFERENCE_NODE;\ncore.Node.ENTITY_NODE                 = ENTITY_NODE;\ncore.Node.PROCESSING_INSTRUCTION_NODE = PROCESSING_INSTRUCTION_NODE;\ncore.Node.COMMENT_NODE                = COMMENT_NODE;\ncore.Node.DOCUMENT_NODE               = DOCUMENT_NODE;\ncore.Node.DOCUMENT_TYPE_NODE          = DOCUMENT_TYPE_NODE;\ncore.Node.DOCUMENT_FRAGMENT_NODE      = DOCUMENT_FRAGMENT_NODE;\ncore.Node.NOTATION_NODE               = NOTATION_NODE;\n\ncore.Node.prototype = {\n  ELEMENT_NODE                : ELEMENT_NODE,\n  ATTRIBUTE_NODE              : ATTRIBUTE_NODE,\n  TEXT_NODE                   : TEXT_NODE,\n  CDATA_SECTION_NODE          : CDATA_SECTION_NODE,\n  ENTITY_REFERENCE_NODE       : ENTITY_REFERENCE_NODE,\n  ENTITY_NODE                 : ENTITY_NODE,\n  PROCESSING_INSTRUCTION_NODE : PROCESSING_INSTRUCTION_NODE,\n  COMMENT_NODE                : COMMENT_NODE,\n  DOCUMENT_NODE               : DOCUMENT_NODE,\n  DOCUMENT_TYPE_NODE          : DOCUMENT_TYPE_NODE,\n  DOCUMENT_FRAGMENT_NODE      : DOCUMENT_FRAGMENT_NODE,\n  NOTATION_NODE               : NOTATION_NODE,\n\n  get children() {\n    if (!this._childrenList) {\n      var self = this;\n      this._childrenList = new core.NodeList(this, function() {\n        return self._childNodes.filter(function(node) {\n          return node.tagName;\n        });\n      });\n    }\n    this._childrenList._update();\n    return this._childrenList;\n  },\n  get nodeValue() {\n    if (this.nodeType === core.Node.TEXT_NODE ||\n        this.nodeType === core.Node.COMMENT_NODE ||\n        this.nodeType === core.Node.PROCESSING_INSTRUCTION_NODE) {\n      return this._data;\n    }\n\n    return null;\n  },\n  set nodeValue(value) {\n    if (this.nodeType === core.Node.TEXT_NODE ||\n        this.nodeType === core.Node.COMMENT_NODE ||\n        this.nodeType === core.Node.PROCESSING_INSTRUCTION_NODE) {\n      this.replaceData(0, this.length, value);\n    }\n  },\n  get parentNode() { return this._parentNode;},\n\n  get nodeName() {\n    switch (this.nodeType) {\n      case ELEMENT_NODE:\n        return this.tagName;\n      case TEXT_NODE:\n        return \"#text\";\n      case PROCESSING_INSTRUCTION_NODE:\n        return this.target;\n      case COMMENT_NODE:\n        return \"#comment\";\n      case DOCUMENT_NODE:\n        return \"#document\";\n      case DOCUMENT_TYPE_NODE:\n        return this.name;\n      case DOCUMENT_FRAGMENT_NODE:\n        return \"#document-fragment\";\n      case ATTRIBUTE_NODE:\n        // TODO: remove this; attributes should not be nodes and should not have a nodeName property\n        // Removing it breaks some legit-seeming xpath tests :-/\n        return this.name;\n    }\n  },\n  set nodeName(unused) { throw new core.DOMException();},\n  get firstChild() {\n    return this._childNodes.length > 0 ? this._childNodes[0] : null;\n  },\n  get ownerDocument() { return this._ownerDocument;},\n  get readonly() { return this._readonly;},\n\n  get lastChild() {\n    var len = this._childNodes.length;\n    return len > 0 ? this._childNodes[len -1] : null;\n  },\n\n  get childNodes() {\n    if (!this._childNodesList) {\n      var self = this;\n      this._childNodesList = new core.NodeList(this, function() {\n        return self._childNodes.slice();\n      });\n    }\n    this._childNodesList._update();\n    return this._childNodesList;\n  },\n  set childNodes(unused) { throw new core.DOMException();},\n\n  _indexOf: function(/*Node*/ child) {\n    return this._childNodes.indexOf(child);\n  },\n\n  get nextSibling() {\n    // find this node's index in the parentNode, add one and call it a day\n    if (!this._parentNode || !this._parentNode._indexOf) {\n      return null;\n    }\n\n    var index = this._parentNode._indexOf(this);\n\n    if (index == -1 || index+1 >= this._parentNode._childNodes.length) {\n      return null;\n    }\n\n    return this._parentNode._childNodes[index+1] || null;\n  },\n  set nextSibling(unused) { throw new core.DOMException();},\n\n  get previousSibling() {\n    if (!this._parentNode || !this._parentNode._indexOf) {\n      return null;\n    }\n\n    var index = this._parentNode._indexOf(this);\n\n    if (index == -1 || index-1 < 0) {\n      return null;\n    }\n\n    return this._parentNode._childNodes[index-1] || null;\n  },\n  set previousSibling(unused) { throw new core.DOMException();},\n\n  /* returns Node */\n  insertBefore :  function(/* Node */ newChild, /* Node*/ refChild) {\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR, 'Attempting to modify a read-only node');\n    }\n\n    // Adopt unowned children, for weird nodes like DocumentType\n    if (!newChild._ownerDocument) newChild._ownerDocument = this._ownerDocument;\n\n    // TODO - if (!newChild) then?\n    if (!(this instanceof core.Document) && newChild._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    }\n\n    if (newChild.nodeType && newChild.nodeType === ATTRIBUTE_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    // search for parents matching the newChild\n    var current = this;\n    do {\n      if (current === newChild) {\n        throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n      }\n    } while((current = current._parentNode));\n\n    // fragments are merged into the element (except parser-created fragments in <template>)\n    if (newChild.nodeType === DOCUMENT_FRAGMENT_NODE && !newChild._templateContent) {\n      var tmpNode, i = newChild._childNodes.length;\n      while (i-- > 0) {\n        tmpNode = newChild.removeChild(newChild.firstChild);\n        this.insertBefore(tmpNode, refChild);\n      }\n    } else if (newChild === refChild) {\n      return newChild;\n    } else {\n      // if the newChild is already in the tree elsewhere, remove it first\n      if (newChild._parentNode) {\n        newChild._parentNode.removeChild(newChild);\n      }\n\n      if (refChild == null) {\n        this._childNodes.push(newChild);\n      } else {\n        var refChildIndex = this._indexOf(refChild);\n        if (refChildIndex == -1) {\n          throw new core.DOMException(NOT_FOUND_ERR);\n        }\n        this._childNodes.splice(refChildIndex, 0, newChild);\n      }\n\n      newChild._parentNode = this;\n      if (this._attached && newChild._attach) {\n        newChild._attach();\n      }\n\n      this._modified();\n      this._descendantAdded(this, newChild);\n    }\n\n    return newChild;\n  }, // raises(DOMException);\n\n  _modified: function() {\n    this._version++;\n    if (this._ownerDocument) {\n      this._ownerDocument._version++;\n    }\n\n    if (this._childrenList) {\n      this._childrenList._update();\n    }\n    this._clearMemoizedQueries()\n  },\n\n  _clearMemoizedQueries: function() {\n    this._memoizedQueries = {};\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._clearMemoizedQueries();\n    }\n  },\n\n  _descendantRemoved: function(parent, child) {\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._descendantRemoved(parent, child);\n    }\n  },\n\n  _descendantAdded: function(parent, child) {\n    if (this._parentNode && this._parentNode !== this) {\n      this._parentNode._descendantAdded(parent, child);\n    }\n  },\n\n  _attrModified: function(name, value, oldValue) {\n    if (name == 'id' && this._attached) {\n      var doc = this._ownerDocument;\n      detachId(oldValue,this,doc);\n      attachId(value,this,doc);\n    }\n\n    // Check for inline event handlers.\n    // We can't set these like other attributes then look it up in\n    // dispatchEvent() because that would create 2 'traditional' event handlers\n    // in the case where there's an inline event handler attribute, plus one\n    // set using element.on* in a script.\n    //\n    // @see http://www.w3.org/TR/2011/WD-html5-20110405/webappapis.html#event-handler-content-attributes\n    if ((name.length > 2) && (name[0] == 'o') && (name[1] == 'n')) {\n        if (value) {\n          var self = this;\n          // Check whether we're the window. This can happen because inline\n          // handlers on the body are proxied to the window.\n          var w = (typeof self.run !== 'undefined') ? self : self._ownerDocument.parentWindow;\n          self[name] = function (event) {\n              // The handler code probably refers to functions declared in the\n              // window context, so we need to call run().\n\n              // Use awesome hacks to get the correct `this` context for the\n              // inline event handler. This would only be necessary if we're an\n              // element, but for the sake of simplicity we also do it on window.\n\n              // Also set event variable and support `return false`.\n              w.__tempContextForInlineEventHandler = self;\n              w.__tempEvent = event;\n              w.run(\"if ((function (event) {\" + value + \"}).call(\" +\n                \"window.__tempContextForInlineEventHandler, window.__tempEvent) === false) {\" +\n                \"window.__tempEvent.preventDefault()}\");\n              delete w.__tempContextForInlineEventHandler;\n              delete w.__tempEvent;\n          };\n        } else {\n          this[name] = null;\n        }\n    }\n  },\n\n  /* returns Node */\n  replaceChild : function(/* Node */ newChild, /* Node */ oldChild){\n    this.insertBefore(newChild, oldChild);\n    return this.removeChild(oldChild);\n  }, //raises(DOMException);\n\n  /* returns void */\n  _attach : function() {\n    this._attached = true;\n    if (this.id) {\n      attachId(this.id,this,this._ownerDocument);\n    }\n    for (var i = 0, len = this._childNodes.length; i < len; i++) {\n      if (this._childNodes[i]._attach) {\n        this._childNodes[i]._attach();\n      }\n    }\n  },\n  /* returns void */\n  _detach : function() {\n    var i, elms;\n    this._attached = false;\n    if (this.id) {\n      detachId(this.id,this,this._ownerDocument);\n    }\n    for (var i = 0, len = this._childNodes.length; i < len; i++) {\n      this._childNodes[i]._detach();\n    }\n  },\n\n  /* returns Node */\n  removeChild : function(/* Node */ oldChild){\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    // TODO - if (!oldChild) then?\n\n    // Use lastIndexOf so that removing all the children by\n    // going backwards through childNodes is fast\n    // (because of splice)\n    var oldChildIndex = this._childNodes.lastIndexOf(oldChild);\n    if (oldChildIndex == -1) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    this._childNodes.splice(oldChildIndex, 1);\n    oldChild._parentNode = null;\n    this._modified();\n    oldChild._detach();\n    this._descendantRemoved(this, oldChild);\n    return oldChild;\n  }, // raises(DOMException);\n\n  /* returns Node */\n  appendChild : function(/* Node */ newChild) {\n    return this.insertBefore(newChild, null);\n  }, // raises(DOMException);\n\n  /* returns boolean */\n  hasChildNodes : function() {\n    return this._childNodes.length > 0;\n  },\n\n  /* returns Node */\n  cloneNode : function(/* bool */ deep, fn) {\n\n    var object = null;\n    switch (this.nodeType) {\n\n      case this.ELEMENT_NODE:\n        object = attrCopy(this,this._ownerDocument.createElementNS(this.namespaceURI, this.nodeName), fn);\n        // Using this.nodeName isn't always exact because of uppercasing-related stuff\n        object._prefix = this._prefix;\n        object._localName = this._localName;\n      break;\n\n      case this.TEXT_NODE:\n        object = attrCopy(this,this._ownerDocument.createTextNode(this.tagName));\n        object.nodeValue = this.nodeValue;\n      break;\n      case this.ATTRIBUTE_NODE:\n        object = this._ownerDocument.createAttribute(this.name);\n      break;\n      break;\n      case this.PROCESSING_INSTRUCTION_NODE:\n        var pi = this._ownerDocument.createProcessingInstruction(this._target,\n                                                                this._data);\n        object = attrCopy(this, pi);\n      break;\n      case this.COMMENT_NODE:\n        object = this._ownerDocument.createComment(this.tagName);\n        object.nodeValue = this.nodeValue;\n      break;\n      case this.DOCUMENT_NODE:\n        object = attrCopy(this, new this.constructor({ parsingMode: this._parsingMode }));\n        // TODO: clone the doctype?\n      break;\n      case this.DOCUMENT_TYPE_NODE:\n        object = new core.DocumentType(this._ownerDocument, this._name, this._publicId, this._systemId);\n      break;\n      case this.DOCUMENT_FRAGMENT_NODE:\n        object = this._ownerDocument.createDocumentFragment();\n      break;\n      default:\n        throw new core.DOMException(NOT_FOUND_ERR);\n      break;\n    }\n\n    if (typeof fn === \"function\") {\n      fn(this, object);\n    }\n\n    if (deep || this.nodeType === ATTRIBUTE_NODE) {\n      var clone = null;\n      for (var i=0,len=this._childNodes.length;i<len;i++)\n      {\n        clone = this._childNodes[i].cloneNode(true);\n        if (clone.nodeType === ATTRIBUTE_NODE) {\n          object.setAttributeNode(clone);\n        } else {\n          var readonly = object._readonly;\n          object._readonly = false;\n          object.appendChild(clone);\n          object._readonly = readonly;\n        }\n      }\n    }\n\n    return object;\n  },\n\n  /* returns void */\n  normalize: function() {\n    var prevChild, child, attr,i;\n\n    if (this._attributes && this._attributes.length) {\n      for (i=0;i<this._attributes.length;i++)\n      {\n        if (this._attributes[i]) {\n          attr = this._attributes[i].normalize();\n        }\n      }\n    }\n\n    for (i=0;i<this._childNodes.length;i++)\n    {\n      child = this._childNodes[i];\n\n      if (child.normalize) {\n        child.normalize();\n      }\n\n      // Level2/core clean off empty nodes\n      if (child.nodeValue === \"\") {\n        this.removeChild(child);\n        i--;\n        continue;\n      }\n\n      if (i>0) {\n        prevChild = this._childNodes[i-1];\n\n        if (child.nodeType === TEXT_NODE &&\n            prevChild.nodeType === TEXT_NODE)\n        {\n\n          // remove the child and decrement i\n          prevChild.appendData(child.nodeValue);\n\n          this.removeChild(child);\n          i--;\n        }\n      }\n    }\n  },\n  toString: function() {\n    var id = '';\n    if (this.id) {\n        id = '#' + this.id;\n    }\n    if (this.className) {\n        var classes = this.className.split(/\\s+/);\n\tfor (var i = 0, len = classes.length; i < len; i++) {\n\t    id += '.' + classes[i];\n\t}\n    }\n    return '[ ' + this.tagName + id + ' ]';\n  },\n  raise: function(type, message, data) {\n    var text = type + \": \" + message;\n\n    if (data) {\n      if (data.exception) {\n        text = data.exception.stack;\n      } else {\n        text += ' - More:\\n' + data;\n      }\n    }\n\n    if (type === \"error\") {\n      if (!this.errors) {\n        this.errors = [];\n      }\n      // TODO: consider using actual `Error` objects or `DOMException`s even..\n      var err = {\n        type    : type,\n        message : message || \"No message\",\n        data    : data || null\n      };\n\n      this.errors.push(err);\n\n      if (this._ownerDocument        &&\n          this._ownerDocument.raise &&\n          this !== this._ownerDocument)\n      {\n        this._ownerDocument.raise(type, message, data);\n      }\n    }\n  }\n};\n\n\ncore.NamedNodeMap = function NamedNodeMap(document) {\n  this._nodes = Object.create(null);\n  this._nsStore = {};\n  this.length = 0;\n  this._ownerDocument = document;\n  this._readonly = false;\n};\ncore.NamedNodeMap.prototype = {\n  get readonly() { return this._readonly;},\n  get ownerDocument() { this._ownerDocument;},\n\n  exists : function(name) {\n    return (this._nodes[name] || this._nodes[name] === null) ? true : false;\n  },\n\n  /* returns Node */\n  getNamedItem: function(/* string */ name) {\n    return this._nodes[name] || null;\n  },\n\n  /* returns Node */\n  setNamedItem: function(/* Node */ arg) {\n\n    // readonly\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    // arg is from a different document\n    if (arg && arg._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    }\n\n    // if this argument is already in use..\n    if (arg && arg._ownerElement) {\n      throw new core.DOMException(INUSE_ATTRIBUTE_ERR);\n    }\n\n    var name = arg.name || arg.tagName;\n    var ret = this._nodes[name];\n    if (!ret) {\n      this.length++;\n      ret = null;\n    }\n    this._nodes[name] = arg;\n\n    // Avoid overwriting prototype methods etc.:\n    if (this.hasOwnProperty(name) || !(name in this)) {\n      this[name] = arg;\n    }\n    return ret;\n  }, // raises: function(DOMException) {},\n\n  /* returns Node */\n  removeNamedItem: function(/* string */ name) {\n\n    // readonly\n    if (this._readonly === true) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (!this._nodes[name]) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    var prev = this._nodes[name] || null;\n    delete this._nodes[name];\n    delete this[name];\n\n    this.length--;\n    return prev;\n  }, // raises: function(DOMException) {},\n\n  /* returns Node */\n  item: function(/* int */ index) {\n    var current = 0;\n    for (var member in this._nodes) {\n      if (current === index && this._nodes[member]) {\n        return this._nodes[member];\n      }\n      current++;\n    }\n    return null;\n  }\n};\n\n//\n// For historical reasons, AttributeList objects must allow accessing\n// attributes as if the object were an associative array. For\n// instance, if `attributes` is an AttributeList object then\n// `attributes.x` should evaluate to the attribute named `x` (which is\n// not in any namespace). The AttributeList class uses the dollar\n// symbol ($) to reduce the possibility of a clash between its field\n// names and possible attribute names. For instance, if the method\n// currently named `$set` were instead named `set` then it would not\n// be possible to access an attribute named `set` through\n// `attributes.set`. The dollar symbol is not valid in attribute names\n// so `$set` cannot clash.\n//\n// Some fields do not get the $ because:\n//\n// * They are part of the API (e.g. `setNamedItem`, `length`), so they\n//   must be visible under a specific name.\n//\n// * Jsdom's code which traverses the DOM tree expects regularly named\n//   fields (e.g. `_parentNode`).\n//\nfunction AttributeList(document, parentNode) {\n  this._ownerDocument = document;\n  this._parentNode = parentNode;\n  this._readonly = false;\n  this._$ns_to_attrs = Object.create(null);\n  this._$name_to_attrs = Object.create(null);\n  this.length = 0;\n}\n\nAttributeList.prototype = {\n  _$reserved: [], // Initialized later\n\n\n  //\n  // Code internal to jsdom and which manipulates an AttributeList\n  // object should use the following methods rather than the methods\n  // that provide the NamedNodeMap interface.\n  //\n\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $getNoNS: function (name) {\n    var attrs = this._$name_to_attrs[name];\n    if (!attrs) {\n      return null;\n    }\n\n    return attrs[0] || null;\n  },\n\n  $getNode: function (namespace, localName) {\n    var attrs = this._$ns_to_attrs[namespace];\n    if (!attrs) {\n      return null;\n    }\n\n    var ret = attrs[localName];\n    if (!ret) {\n      return null;\n    }\n\n    return ret;\n  },\n\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $setNoNS: function (name, value, dontValidate) {\n    var attr = this.$getNoNS(name);\n    if (!attr) {\n      this.$set(name, value, undefined, undefined, undefined, dontValidate);\n      return;\n    }\n\n    var prev_val = attr.value;\n    attr.value = value;\n\n    this._parentNode._attrModified(attr.name, attr.value, prev_val);\n    this._parentNode._modified();\n  },\n\n  $set: function (localName, value, name, prefix, namespace, dontValidate) {\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (name === undefined) {\n      name = localName;\n    }\n\n    if (prefix === undefined) {\n      prefix = null;\n    }\n\n    if (namespace === undefined) {\n      namespace = null;\n    }\n\n    var prev_attr = this.$getNode(namespace, localName);\n    var attr;\n\n    var prev_val = null;\n    if (prev_attr) {\n      prev_val = prev_attr.value;\n      prev_attr._prefix = prefix;\n      prev_attr.value = value;\n      attr = prev_attr;\n\n      this._parentNode._attrModified(attr.name, attr.value, prev_val);\n      this._parentNode._modified();\n    }\n    else {\n      var method = dontValidate ? '_createAttributeNoNameValidation' : 'createAttribute';\n      attr = this._ownerDocument[method](name);\n      attr._ownerElement = this._parentNode;\n      attr.value = value;\n      attr._namespaceURI = namespace;\n      attr._prefix = prefix;\n      attr._localName = localName;\n      attr._parentNode = this._parentNode;\n      this.$setNode(attr);\n      // $setNode calls the parent node methods.\n    }\n  },\n\n  $setNode: function (attr) {\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    if (attr.nodeType !== ATTRIBUTE_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    if (attr._ownerDocument !== this._ownerDocument) {\n      throw new core.DOMException(WRONG_DOCUMENT_ERR);\n    }\n\n    if (attr._parentNode && attr._parentNode !== this._parentNode) {\n      throw new core.DOMException(INUSE_ATTRIBUTE_ERR);\n    }\n\n    var localName = attr._localName;\n    var name = attr.name;\n    var prefix = attr._prefix;\n    var namespace = attr._namespaceURI;\n\n    if (name === undefined) {\n      name = localName;\n    }\n\n    if (prefix === undefined) {\n      prefix = null;\n    }\n\n    if (namespace === undefined) {\n      namespace = null;\n    }\n\n    var prev_attr = this.$getNode(namespace, localName);\n\n    var prev_val = null;\n    if (prev_attr) {\n      prev_val = prev_attr.value;\n      // Remove the old attribute\n      this._$onlyRemoveNode(prev_attr);\n    }\n\n    attr._parentNode = this._parentNode;\n    attr._ownerElement = this._parentNode;\n\n    var attrs = this._$ns_to_attrs[namespace];\n    if (!attrs) {\n      attrs = this._$ns_to_attrs[namespace] = Object.create(null);\n    }\n    attrs[localName] = attr;\n\n    attrs = this._$name_to_attrs[name];\n    if (!attrs) {\n      attrs = this._$name_to_attrs[name] = [attr];\n    }\n    else {\n      attrs.push(attr);\n    }\n\n    // Only attributes in the null namespace can be set this way.\n    if (namespace === null) {\n      // Make the node a field on this object but ONLY if it does not\n      // clash with the reserved names.\n      if (this._$reserved.indexOf(name) === -1) {\n        this[name] = attr;\n      }\n    }\n\n    this[this.length] = attr;\n    this.length++;\n\n    this._parentNode._attrModified(attr.name, attr.value, prev_val);\n    this._parentNode._modified();\n\n    return prev_attr;\n  },\n\n  // This method *ignores* namespaces. This is *not* the same thing as\n  // requesting an attribute with a null namespace.\n  $removeNoNS: function (name) {\n    var attr = this.$getNoNS(name);\n    return attr ? this.$removeNode(attr) : null;\n  },\n\n  $remove: function (namespace, localName) {\n    var attr = this.$getNode(namespace, localName);\n    return attr ? this.$removeNode(attr) : null;\n  },\n\n  /* Only removes the node, and does not add a default value. */\n  _$onlyRemoveNode: function (attr) {\n    var namespace = attr._namespaceURI;\n    var localName = attr._localName;\n\n    var attrs = this._$ns_to_attrs[namespace];\n    if (!attrs) {\n      return null;\n    }\n\n    var found_attr = attrs[localName];\n    if (found_attr !== attr) {\n      return null;\n    }\n\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    attr._ownerElement = null;\n    attr._parentNode = null;\n    delete attrs[localName];\n\n    attrs = this._$name_to_attrs[attr.name];\n    attrs.splice(attrs.indexOf(attr), 1);\n\n    var ix = Array.prototype.indexOf.call(this, attr);\n    // Splice also modifies length.\n    Array.prototype.splice.call(this, ix, 1);\n\n    if (this[attr.name] === attr) {\n      delete this[attr.name];\n    }\n\n    this._parentNode._attrModified(attr.name);\n    this._parentNode._modified();\n\n    return attr;\n  },\n\n  $removeNode: function (attr) {\n    if (!this._$onlyRemoveNode(attr)) {\n      return null;\n    }\n    return attr;\n  },\n\n  // Although http://dom.spec.whatwg.org/#concept-element-attribute\n  // does not specify that the attributes field on an Element should\n  // support NamedNodeMap, in practice browsers still support this\n  // interface so we should support it for compatibility.\n\n  getNamedItem: function (name) {\n    return this.getNamedItemNS(null, name);\n  },\n  removeNamedItem: function (name) {\n    return this.removeNamedItemNS(null, name);\n  },\n  item: function (i) {\n      return this[i];\n  },\n  getNamedItemNS: function (namespaceURI, localName) {\n    if (namespaceURI === \"\") {\n      namespaceURI = null;\n    }\n\n    return this.$getNode(namespaceURI, localName);\n  },\n  removeNamedItemNS: function (namespaceURI, localName) {\n    var ret = this.$remove(namespaceURI, localName);\n\n    if (ret === null) {\n      throw new core.DOMException(NOT_FOUND_ERR);\n    }\n\n    return ret;\n  }\n};\n\n// Alias these methods.\nAttributeList.prototype.setNamedItem = AttributeList.prototype.$setNode;\nAttributeList.prototype.setNamedItemNS = AttributeList.prototype.$setNode;\n\n(function () {\n  // Construct the list of reserved attribute names from a temporarily\n  // created AttributeList and from the chain of prototypes. We need\n  // this because JavaScript code running an a browser expects to be\n  // able to do el.attributes.x to get the value of the attribute \"x\"\n  // on an element. Unfortunately, JavaScript *currently* does not\n  // allow us to elegantly provide such functionality without risking\n  // a clash with the fields and methods set on the AttributeList\n  // object. Hence we need a list of reserved field names.\n\n  var reserved = Object.keys(new AttributeList());\n  var prototype = AttributeList.prototype;\n  while (prototype) {\n    reserved = reserved.concat(Object.getOwnPropertyNames(prototype));\n    prototype = Object.getPrototypeOf(prototype);\n  }\n  AttributeList.prototype._$reserved = reserved;\n})();\n\ncore.AttributeList = AttributeList;\n\ncore.Element = function Element(document, localName) {\n  core.Node.call(this, document);\n  this._namespaceURI = null;\n  this._prefix = null;\n  this._localName = localName;\n};\n\ninheritFrom(core.Node, core.Element, {\n  get namespaceURI() {\n    return this._namespaceURI;\n  },\n  get prefix() {\n    return this._prefix;\n  },\n  get localName() {\n    return this._localName;\n  },\n  get tagName() {\n    var qualifiedName = this._prefix !== null ? this._prefix + \":\" + this._localName : this._localName;\n    if (this.namespaceURI === \"http://www.w3.org/1999/xhtml\" && this._ownerDocument._parsingMode === \"html\") {\n      qualifiedName = qualifiedName.toUpperCase();\n    }\n    return qualifiedName;\n  },\n\n  get id() {\n    var idAttr = this.getAttribute(\"id\");\n    if (idAttr === null) {\n      return \"\";\n    }\n    return idAttr;\n  },\n\n  nodeType : ELEMENT_NODE,\n  get attributes() {\n    return this._attributes;\n  },\n\n  get sourceIndex() {\n    /*\n    * According to QuirksMode:\n    * Get the sourceIndex of element x. This is also the index number for\n    * the element in the document.getElementsByTagName('*') array.\n    * http://www.quirksmode.org/dom/w3c_core.html#t77\n    */\n    var items = this.ownerDocument.getElementsByTagName('*'),\n        len = items.length;\n\n    for (var i = 0; i < len; i++) {\n      if (items[i] === this) {\n        return i;\n      }\n    }\n  },\n\n  get outerHTML() {\n    return domToHtml(this, true);\n  },\n\n  get innerHTML() {\n    var tagName = this.tagName;\n    if (tagName === 'SCRIPT' || tagName === 'STYLE') {\n      var type = this.getAttribute('type');\n      if (!type || /^text\\//i.test(type) || /\\/javascript$/i.test(type)) {\n        return domToHtml(this._childNodes, true, true);\n      }\n    }\n\n    // In case of <template> we should pass it's content fragment as a serialization root if we have one\n    if(tagName === 'TEMPLATE' &&\n       this._namespaceURI === 'http://www.w3.org/1999/xhtml' &&\n       this._childNodes[0] && this._childNodes[0]._templateContent) {\n      return domToHtml(this._childNodes[0]._childNodes, true);\n    }\n\n    return domToHtml(this._childNodes, true);\n  },\n\n  set innerHTML(html) {\n    setInnerHTML(this.ownerDocument, this, html);\n  },\n\n  scrollTop: 0,\n  scrollLeft: 0,\n\n  hasAttributes: function () {\n    return this._attributes.length > 0;\n  },\n\n  /* returns Attr */\n  setAttributeNode: function(/* Attr */ newAttr) {\n    var prevNode = this._attributes.$getNode(null, newAttr.name);\n    if (prevNode) {\n      prevNode._ownerElement = null;\n    }\n\n    newAttr._ownerElement = this;\n    this._attributes.$setNode(newAttr);\n\n    return (prevNode && prevNode.specified) ? prevNode : null;\n  }, //  raises: function(DOMException) {},\n\n  /* returns Attr */\n  removeAttributeNode: function(/* Attr */ oldAttr) {\n    var ret = this._attributes.$removeNode(oldAttr);\n\n    if (ret !== null) {\n      return ret;\n    }\n\n    throw new core.DOMException(NOT_FOUND_ERR);\n  }, //raises: function(DOMException) {},\n\n  /* returns NodeList */\n  getElementsByTagName: memoizeQuery(function(/* string */ name) {\n    name = name.toLowerCase();\n\n    function filterByTagName(child) {\n      if (child.nodeName && child.nodeType === ELEMENT_NODE) {\n        return name === \"*\" || (child.nodeName.toLowerCase() === name);\n      }\n\n      return false;\n    }\n    return new core.NodeList(this._ownerDocument || this, core.mapper(this, filterByTagName, true));\n  }),\n\n  getElementsByClassName: function (className) {\n\n    function filterByClassName(child) {\n      if (!child) {\n        return false;\n      }\n\n      var classString = child.className;\n      if (classString) {\n        var s = classString.split(\" \");\n        for (var i = 0; i < s.length; i++) {\n          if (s[i] === className) {\n            return true;\n          }\n        }\n      }\n      return false;\n    }\n\n    return new core.NodeList(this.ownerDocument || this, core.mapper(this, filterByClassName));\n  }\n});\n\ncore.DocumentFragment = function DocumentFragment(document) {\n  core.Node.call(this, document);\n};\ninheritFrom(core.Node, core.DocumentFragment, {\n  nodeType : DOCUMENT_FRAGMENT_NODE\n});\n\ncore.Document = function Document(options) {\n  if (!options || !options.parsingMode || (options.parsingMode !== \"html\" && options.parsingMode !== \"xml\")) {\n    throw new Error(\"options must exist and contain a parsingMode of html or xml\");\n  }\n\n  core.Node.call(this, \"#document\");\n  this._parsingMode = options.parsingMode;\n  this._implementation = new core.DOMImplementation(this);\n  this._documentElement = null;\n  this._ids = Object.create(null);\n  this._attached = true;\n  this._ownerDocument = this;\n  this._readonly = false;\n\n  this._contentType = options.contentType;\n  if (this._contentType === undefined) {\n    this._contentType = this._parsingMode === \"xml\" ? \"application/xml\" : \"text/html\";\n  }\n\n  this._URL = options.url;\n  if (this._URL === undefined) {\n    this._URL = \"about:blank\";\n  }\n  this._location = new Location(this._URL, this);\n};\n\n\nvar tagRegEx = /[^\\w:\\d_\\.-]+/i;\nvar entRegEx = /[^\\w\\d_\\-&;]+/;\nvar invalidAttrRegEx = /[\\s\"'>/=\\u0000-\\u001A]/;\n\ninheritFrom(core.Node, core.Document, {\n  nodeType : DOCUMENT_NODE,\n  _elementBuilders : { },\n  _defaultElementBuilder: function(document, tagName) {\n    return new core.Element(document, tagName);\n  },\n  get contentType() { return this._contentType;},\n  get compatMode() { return (this._parsingMode === \"xml\" || this.doctype) ? \"CSS1Compat\" : \"BackCompat\"; },\n  get characterSet() { return \"UTF-8\"; },\n  get inputEncoding() { return \"UTF-8\"; },\n  get doctype() {\n    for (var i = 0; i < this._childNodes.length; ++i) {\n      if (this._childNodes[i].nodeType === DOCUMENT_TYPE_NODE) {\n        return this._childNodes[i];\n      }\n    }\n    return null;\n  },\n  get URL() {\n    return this._URL;\n  },\n  get documentURI() {\n    return this._URL;\n  },\n  get location() {\n    return this._location;\n  },\n  get documentElement() {\n    if (this._documentElement) {\n      return this._documentElement;\n    } else {\n      for (var i = 0; i < this._childNodes.length; ++i) {\n        if (this._childNodes[i].nodeType === ELEMENT_NODE) {\n          this._documentElement = this._childNodes[i];\n          return this._documentElement;\n        }\n      }\n      return null;\n    }\n  },\n\n  get implementation() { return this._implementation;},\n  set implementation(implementation) { this._implementation = implementation;},\n  get ownerDocument() { return null;},\n  get readonly() { return this._readonly;},\n\n  set parentWindow(window) {\n    // Contextify does not support getters and setters, so we have to set them\n    // on the original object instead.\n    window._frame = function (name, frame) {\n      if (typeof frame === 'undefined') {\n        delete window[name];\n      } else {\n        defineGetter(window, name, function () { return frame.contentWindow; });\n      }\n    };\n    this._parentWindow = window.getGlobal();\n  },\n\n  get defaultView() {\n    return this.parentWindow;\n  },\n\n  toString: function () {\n    return '[object HTMLDocument]';\n  },\n\n  _createElementNoTagNameValidation: function (tagName) {\n    var element = (this._elementBuilders[tagName.toLowerCase()] || this._defaultElementBuilder)(this, tagName);\n    element._namespaceURI = \"http://www.w3.org/1999/xhtml\";\n    return element;\n  },\n\n  createElement: function (localName) {\n    localName = String(localName);\n    validateName(localName, core);\n    if (this._parsingMode === \"html\") {\n      localName = localName.toLowerCase();\n    }\n\n    return this._createElementNoTagNameValidation(localName);\n  },\n\n  /* returns DocumentFragment */\n  createDocumentFragment: function() {\n    return new core.DocumentFragment(this);\n  },\n\n  /* returns Attr */\n  createAttribute: function (localName) {\n    localName = String(localName);\n    validateName(localName, core);\n\n    return this._createAttributeNoNameValidation(localName);\n  }, // raises: function(DOMException) {},\n\n  _createAttributeNoNameValidation: function (localName) {\n    return new core.Attr(this, localName, \"\");\n  },\n\n  appendChild : function(/* Node */ arg) {\n    if (this.documentElement && arg.nodeType == ELEMENT_NODE) {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n    return core.Node.prototype.appendChild.call(this, arg);\n  },\n\n  removeChild : function(/* Node */ arg) {\n    var ret = core.Node.prototype.removeChild.call(this, arg);\n    if (arg == this._documentElement) {\n      this._documentElement = null;// force a recalculation\n    }\n    return ret;\n  },\n\n  /* returns NodeList */\n  getElementsByTagName: memoizeQuery(function(/* string */ name) {\n    function filterByTagName(child) {\n      if (child.nodeName && child.nodeType === ELEMENT_NODE)\n      {\n        if (name === \"*\") {\n          return true;\n\n        // case insensitivity for html\n        } else if (child._ownerDocument && child._ownerDocument._doctype &&\n                   //child._ownerDocument._doctype.name === \"html\" &&\n                   child.nodeName.toLowerCase() === name.toLowerCase())\n        {\n          return true;\n        } else if (child.nodeName.toLowerCase() === name.toLowerCase()) {\n          return true;\n        }\n      }\n      return false;\n    }\n    return new core.NodeList(this.documentElement || this, core.mapper(this, filterByTagName, true));\n  }),\n\n  getElementsByClassName: function (className) {\n\n    function filterByClassName(child) {\n      if (!child) {\n        return false;\n      }\n\n      var classString = child.className;\n      if (classString) {\n        var s = classString.split(\" \");\n        for (var i = 0; i < s.length; i++) {\n          if (s[i] === className) {\n            return true;\n          }\n        }\n      }\n      return false;\n    }\n\n    return new core.NodeList(this.ownerDocument || this, core.mapper(this, filterByClassName));\n  },\n\n  write: function (text) {\n    if (this._writeAfterElement) {\n      // If called from an script element directly (during the first tick),\n      // the new elements are inserted right after that element.\n      var tempDiv = this.createElement('div');\n      setInnerHTML(this, tempDiv, text);\n\n      var child = tempDiv.firstChild;\n      var previous = this._writeAfterElement;\n      var parent = this._writeAfterElement.parentNode;\n\n      while (child) {\n        var node = child;\n        child = child.nextSibling;\n        parent.insertBefore(node, previous.nextSibling);\n        previous = node;\n      }\n    } else if (this.readyState === \"loading\") {\n      // During page loading, document.write appends to the current element\n      // Find the last child that has been added to the document.\n      var node = this;\n      while (node.lastChild && node.lastChild.nodeType === this.ELEMENT_NODE) {\n        node = node.lastChild;\n      }\n      setInnerHTML(this, node, text || \"<html><head></head><body></body></html>\");\n    } else if (text) {\n      setInnerHTML(this, this, text);\n    }\n  }\n});\n\ncore.Attr = function Attr(document, name, value) {\n  core.Node.call(this, document);\n  this._valueForAttrModified = value;\n  this._name = name;\n  this._ownerElement = null;\n  this._namespaceURI = null;\n  this._localName = name;\n  this._prefix = null;\n};\ninheritFrom(core.Node, core.Attr, {\n  nodeType : ATTRIBUTE_NODE,\n  get namespaceURI() {\n    return this._namespaceURI;\n  },\n  get prefix() {\n    return this._prefix;\n  },\n  get localName() {\n    return this._localName;\n  },\n  get name() {\n    return this._name;\n  },\n  get ownerElement() {\n    return this._ownerElement;\n  },\n  get nodeValue() {\n    var val = '';\n    for (var i=0,len=this._childNodes.length;i<len;i++) {\n      var child = this._childNodes[i];\n      val += child.nodeValue;\n    }\n    return val;\n  },\n  set nodeValue(value) {\n    // readonly\n    if (this._readonly) {\n      throw new core.DOMException(NO_MODIFICATION_ALLOWED_ERR);\n    }\n\n    this._childNodes.length = 1;\n    this._childNodes[0] = this._ownerDocument.createTextNode(value);\n    this._modified();\n    var prev = this._valueForAttrModified;\n    this._nodeValue = value;\n    if (this._ownerElement) {\n      this._ownerElement._attrModified(this._name, value, prev);\n    }\n  },\n  get specified() {\n    return true;\n  },\n  get value() {\n    return this.nodeValue;\n  },\n  set value(value) {\n    this.nodeValue = value;\n  },\n  get parentNode() { return null;},\n\n  insertBefore : function(/* Node */ newChild, /* Node*/ refChild){\n    if (newChild.nodeType === CDATA_SECTION_NODE ||\n        newChild.nodeType === ELEMENT_NODE)\n    {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    return core.Node.prototype.insertBefore.call(this, newChild, refChild);\n  },\n\n  appendChild : function(/* Node */ arg) {\n\n    if (arg.nodeType === CDATA_SECTION_NODE ||\n        arg.nodeType === ELEMENT_NODE)\n    {\n      throw new core.DOMException(HIERARCHY_REQUEST_ERR);\n    }\n\n    return core.Node.prototype.appendChild.call(this, arg);\n  }\n\n});\n"]},"metadata":{},"sourceType":"script"}